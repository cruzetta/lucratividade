<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Ferramentas de Negócio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.379.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Garante que o cabeçalho fixo não cubra o título da secção ao navegar */
        section {
            scroll-margin-top: 80px;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        #simulation-panel {
            transition: opacity 0.5s ease-in-out, max-height 0.8s ease-in-out;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .highlight-card {
            background-color: #fffbeb;
            border: 1px solid #facc15;
        }
        /* Estilos do Analisador */
        #analisador .input-group input { padding-left: 2.75rem; }
        #analisador .input-group .icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #6b7280; }
        #analisador .result-card { transition: all 0.3s ease-in-out; }
        #analisador .loader {
            border-top-color: #3498db;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .csv-instructions {
            background-color: #f3f4f6;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            margin-top: 1.5rem;
            border-radius: 0.5rem;
        }
        .btn-save-feedback {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- CABEÇALHO DE NAVEGAÇÃO FIXO -->
    <header class="bg-white/80 backdrop-blur-lg shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 md:px-8 flex justify-between items-center h-16">
            <div class="flex space-x-4 md:space-x-8">
                <a href="#analisador" class="text-slate-600 hover:text-indigo-600 font-semibold transition self-center">Analisador Mensal</a>
                <a href="#calculadora" class="text-slate-600 hover:text-indigo-600 font-semibold transition self-center">Calculadora de Preços</a>
                <a href="#calculo-diario" class="text-slate-600 hover:text-indigo-600 font-semibold transition self-center">Cálculo Diário</a>
            </div>
            <a href="https://wa.me/5567999093031" target="_blank" rel="noopener noreferrer" class="hidden sm:inline-flex items-center bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-all transform hover:scale-105">
                <i data-lucide="message-circle" class="h-5 w-5 mr-2"></i>
                Fale Comigo
            </a>
        </nav>
    </header>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- ================================================================== -->
        <!-- SECÇÃO 1: ANALISADOR DE LUCRATIVIDADE                          -->
        <!-- ================================================================== -->
        <section id="analisador" class="py-8">
             <div class="max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Analisador de Lucratividade Mensal</h1>
                    <p class="text-gray-600 mt-2">Uma visão completa da saúde financeira do seu negócio.</p>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-8">
                    <!-- Funcionalidade de Importação -->
                    <div>
                        <h2 class="text-xl font-semibold text-gray-700 border-l-4 border-blue-500 pl-4 mb-4">Importação de Dados</h2>
                        <div class="flex space-x-4">
                            <button id="import-products-btn" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-600 flex items-center">
                                <i data-lucide="upload-cloud" class="h-5 w-5 mr-2"></i> Importar Produtos (CSV)
                            </button>
                             <button id="import-expenses-btn" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-600 flex items-center">
                                <i data-lucide="upload-cloud" class="h-5 w-5 mr-2"></i> Importar Despesas (CSV)
                            </button>
                        </div>
                        <input type="file" id="products-csv-input" class="hidden" accept=".csv">
                        <input type="file" id="expenses-csv-input" class="hidden" accept=".csv">

                        <div class="csv-instructions">
                            <p class="font-semibold text-gray-800">Como preparar seus ficheiros CSV:</p>
                            <p class="mt-2 text-sm text-gray-600"><strong>Para Produtos:</strong> Crie 4 colunas no seu Excel, exatamente nesta ordem: `Nome do Produto`, `Custo`, `Preço de Venda`, `Quantidade Vendida`. Sem cabeçalho.</p>
                            <p class="mt-1 text-sm text-gray-600"><strong>Para Despesas:</strong> Crie 2 colunas: `Nome da Despesa`, `Valor`. Os nomes das despesas devem ser exatos (ex: "Aluguel", "Impostos sobre Faturamento (%)").</p>
                            <p class="mt-1 text-sm text-gray-600">Depois, no Excel, vá a "Ficheiro > Guardar como" e escolha o formato "CSV (delimitado por vírgulas)".</p>
                        </div>
                    </div>


                    <!-- Entradas do Analisador -->
                    <div>
                        <h2 class="text-xl font-semibold text-gray-700 border-l-4 border-blue-500 pl-4 mb-4">1. Seus Produtos (Média Mensal)</h2>
                        <div id="analisador-product-list" class="space-y-4">
                            <div class="product-item grid grid-cols-1 md:grid-cols-12 gap-2 items-center border p-3 rounded-lg">
                                <input type="text" placeholder="Nome do Produto (Ex: Hambúrguer)" class="md:col-span-4 p-2 border rounded-md" data-field="name">
                                <input type="number" placeholder="Custo (R$)" class="md:col-span-2 p-2 border rounded-md" data-field="cost">
                                <input type="number" placeholder="Preço Venda (R$)" class="md:col-span-2 p-2 border rounded-md" data-field="price">
                                <input type="number" placeholder="Qtd. Vendida" class="md:col-span-2 p-2 border rounded-md" data-field="quantity">
                                <button class="remove-product-btn bg-red-100 text-red-600 p-2 rounded-md hover:bg-red-200 md:col-span-2 flex items-center justify-center">
                                    <i data-lucide="trash-2" class="h-5 w-5"></i> <span class="ml-2 hidden md:inline">Remover</span>
                                </button>
                            </div>
                        </div>
                        <button id="analisador-add-product-btn" class="mt-4 bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600 flex items-center">
                            <i data-lucide="plus-circle" class="h-5 w-5 mr-2"></i> Adicionar Produto
                        </button>
                    </div>
                    <div>
                         <h2 class="text-xl font-semibold text-gray-700 border-l-4 border-blue-500 pl-4 mb-4">2. Suas Despesas Mensais</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div class="space-y-4">
                                <h3 class="text-lg font-medium text-gray-600">Despesas Fixas</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="relative input-group"><i data-lucide="home" class="icon"></i><input type="number" placeholder="Aluguel" id="rent" class="w-full p-2 border rounded-md" data-label="Aluguel"></div>
                                    <div class="relative input-group"><i data-lucide="users" class="icon"></i><input type="number" placeholder="Salários e Encargos" id="salaries" class="w-full p-2 border rounded-md" data-label="Salarios e Encargos"></div>
                                    <div class="relative input-group"><i data-lucide="briefcase" class="icon"></i><input type="number" placeholder="Pró-labore" id="proLabore" class="w-full p-2 border rounded-md" data-label="Pro-labore"></div>
                                    <div class="relative input-group"><i data-lucide="droplet" class="icon"></i><input type="number" placeholder="Água" id="water" class="w-full p-2 border rounded-md" data-label="Agua"></div>
                                    <div class="relative input-group"><i data-lucide="zap" class="icon"></i><input type="number" placeholder="Energia" id="energy" class="w-full p-2 border rounded-md" data-label="Energia"></div>
                                    <div class="relative input-group"><i data-lucide="flame" class="icon"></i><input type="number" placeholder="Gás" id="gas" class="w-full p-2 border rounded-md" data-label="Gas"></div>
                                    <div class="relative input-group"><i data-lucide="megaphone" class="icon"></i><input type="number" placeholder="Publicidade" id="advertising" class="w-full p-2 border rounded-md" data-label="Publicidade"></div>
                                    <div class="relative input-group"><i data-lucide="spray-can" class="icon"></i><input type="number" placeholder="Produtos de Limpeza" id="cleaning" class="w-full p-2 border rounded-md" data-label="Produtos de Limpeza"></div>
                                </div>
                                <div class="pt-2">
                                    <h4 class="text-md font-medium text-gray-600 mb-2">Outras Despesas Fixas</h4>
                                    <div id="fixed-expenses-list" class="space-y-3"></div>
                                    <button id="add-expense-btn" class="mt-3 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 flex items-center text-sm"><i data-lucide="plus" class="h-4 w-4 mr-2"></i> Adicionar Despesa</button>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <h3 class="text-lg font-medium text-gray-600">Despesas Variáveis</h3>
                                <div class="relative input-group"><span class="icon">%</span><input type="number" placeholder="Impostos sobre Faturamento (%)" id="taxesPercentage" class="w-full p-2 border rounded-md" data-key="Impostos sobre Faturamento (%)"></div>
                                <div class="relative input-group"><span class="icon">%</span><input type="number" placeholder="Taxas de Cartão/Marketplace (%)" id="feesPercentage" class="w-full p-2 border rounded-md" data-key="Taxas de Cartão/Marketplace (%)"></div>
                                <div class="relative input-group"><span class="icon">%</span><input type="number" placeholder="Perdas e Desperdícios (%)" id="wastePercentage" class="w-full p-2 border rounded-md" data-key="Perdas e Desperdícios (%)"></div>
                            </div>
                        </div>
                    </div>
                    <div class="pt-4 text-center">
                        <button id="calculate-btn" class="w-full md:w-1/2 bg-green-600 text-white font-bold text-lg py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300">
                            Analisar Lucratividade
                        </button>
                    </div>
                </div>

                <!-- Área de Resultado do Analisador -->
                <div id="result-section" class="mt-8 hidden">
                     <h2 class="text-2xl md:text-3xl font-bold text-center mb-6 text-gray-800">Diagnóstico Financeiro</h2>
                    <div id="profit-loss-message" class="p-4 rounded-lg text-center text-xl font-bold mb-6"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="bg-white p-5 rounded-xl shadow"><h3 class="font-semibold text-center text-gray-700 mb-4">Composição do Faturamento</h3><canvas id="compositionChart"></canvas></div>
                        <div class="bg-white p-5 rounded-xl shadow"><h3 class="font-semibold text-center text-gray-700 mb-4">Visão Geral Financeira</h3><canvas id="overviewChart"></canvas></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                        <div class="result-card bg-white p-5 rounded-xl shadow"><h4 class="font-semibold text-gray-500">Faturamento Bruto</h4><p id="total-revenue-analyzer" class="text-2xl font-bold text-blue-600"></p></div>
                        <div class="result-card bg-white p-5 rounded-xl shadow"><h4 class="font-semibold text-gray-500">Custo dos Produtos (CMV)</h4><p id="total-cogs" class="text-2xl font-bold text-orange-600"></p></div>
                        <div class="result-card bg-white p-5 rounded-xl shadow"><h4 class="font-semibold text-gray-500">Lucro Bruto</h4><p id="gross-profit" class="text-2xl font-bold text-teal-600"></p><p id="gross-profit-margin" class="text-sm text-gray-500"></p></div>
                        <div class="result-card bg-white p-5 rounded-xl shadow"><h4 class="font-semibold text-gray-500">Despesas Operacionais</h4><p id="total-expenses" class="text-2xl font-bold text-red-600"></p><p id="expenses-breakdown" class="text-sm text-gray-500"></p></div>
                        <div class="result-card bg-white p-5 rounded-xl shadow"><h4 class="font-semibold text-gray-500">Ponto de Equilíbrio</h4><p id="break-even" class="text-2xl font-bold text-indigo-600"></p><p class="text-sm text-gray-500">Faturamento mínimo para cobrir os custos</p></div>
                        <div class="result-card bg-white p-5 rounded-xl shadow border-2" id="net-profit-card"><h4 class="font-semibold text-gray-500">Resultado Final (Lucro/Prejuízo)</h4><p id="net-profit" class="text-3xl font-extrabold"></p><p id="net-profit-margin" class="text-sm font-medium"></p></div>
                    </div>
                    <div class="mt-10 text-center">
                        <button id="gemini-analysis-btn" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition duration-300 flex items-center justify-center mx-auto">
                           <span id="gemini-btn-text">✨ Gerar Análise com IA</span>
                           <div id="gemini-loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></div>
                        </button>
                        <div id="gemini-result-container" class="mt-6 bg-white p-6 rounded-xl shadow hidden prose prose-indigo max-w-none text-left"></div>
                    </div>
                    <div class="mt-8 text-center">
                        <button id="export-analyzer-csv-btn" class="bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-800 flex items-center justify-center mx-auto">
                            <i data-lucide="sheet" class="h-5 w-5 mr-2"></i> Exportar Dados (CSV)
                        </button>
                    </div>
                </div>
                <div id="error-message" class="mt-6 p-4 text-center text-red-700 bg-red-100 font-medium rounded-lg hidden"></div>
            </div>
        </section>

        <hr class="my-12 border-slate-300">

        <!-- ================================================================== -->
        <!-- SECÇÃO 2: CALCULADORA DE PREÇO POR META DE VENDAS            -->
        <!-- ================================================================== -->
        <section id="calculadora" class="py-8">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Calculadora de Preço por Meta de Vendas</h1>
                <p class="mt-2 text-md md:text-lg text-slate-600">Planeie a sua estratégia de preços para atingir os seus objetivos de lucro.</p>
            </header>
            <main id="calculator-input-section" class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="card col-span-1 md:col-span-2">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-900">1. Custos da Operação</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="fixed-costs" class="block text-sm font-medium text-slate-700">Total Despesas Fixas Mensais (R$)</label>
                                <input type="number" id="fixed-costs" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Ex: 20000">
                            </div>
                            <div>
                                <label for="variable-costs" class="block text-sm font-medium text-slate-700">Despesas Variáveis (%)</label>
                                <input type="number" id="variable-costs" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Ex: 15">
                            </div>
                        </div>
                    </div>
                    <div class="card col-span-1">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-900">2. Meta de Negócio</h2>
                        <div>
                            <label for="profit-goal" class="block text-sm font-medium text-slate-700">Lucro Livre Mensal Desejado (R$)</label>
                            <input type="number" id="profit-goal" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Ex: 10000">
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-900">3. Produtos/Serviços</h2>
                    <!-- NOVA SECÇÃO DE IMPORTAÇÃO PARA A CALCULADORA -->
                    <div class="mb-6">
                        <h3 class="text-lg font-medium text-gray-700 mb-2">Importar de Planilha</h3>
                        <button id="import-calculator-products-btn" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-600 flex items-center">
                            <i data-lucide="upload-cloud" class="h-5 w-5 mr-2"></i> Importar Produtos (CSV)
                        </button>
                        <input type="file" id="calculator-csv-input" class="hidden" accept=".csv">
                        <div class="csv-instructions">
                            <p class="font-semibold text-gray-800">Como preparar seu ficheiro CSV:</p>
                            <p class="mt-2 text-sm text-gray-600">Crie até 4 colunas no seu Excel: `Nome do Produto`, `Custo Direto`, `Meta de Vendas`, `Preço de Venda`. Sem cabeçalho.</p>
                            <p class="mt-1 text-sm text-gray-600">Depois, no Excel, vá a "Ficheiro > Guardar como" e escolha o formato "CSV (delimitado por vírgulas)".</p>
                        </div>
                    </div>

                    <div id="calculator-product-list" class="space-y-4">
                        <div id="product-template" class="grid grid-cols-12 gap-x-4 gap-y-2 items-end p-2 rounded-lg border border-transparent" style="display: none;">
                            <div class="col-span-12 sm:col-span-4 md:col-span-3">
                                <label class="block text-sm font-medium text-slate-700">Nome do Produto</label>
                                <input type="text" name="product-name" class="input-field mt-1 w-full" placeholder="Ex: Sagrado Burger">
                            </div>
                            <div class="col-span-6 sm:col-span-4 md:col-span-2">
                                <label class="block text-sm font-medium text-slate-700">Custo Direto (R$)</label>
                                <input type="number" name="direct-cost" class="input-field mt-1 w-full" placeholder="Ex: 15">
                            </div>
                            <div class="col-span-6 sm:col-span-4 md:col-span-2">
                                <label class="block text-sm font-medium text-slate-700">Meta Vendas (Unid.)</label>
                                <input type="number" name="sales-goal" class="input-field mt-1 w-full" placeholder="Ex: 500">
                            </div>
                            <div class="col-span-12 sm:col-span-8 md:col-span-3">
                                <label class="block text-sm font-medium text-slate-700">Preço Venda Atual (R$) <span class="text-slate-500">(Opcional)</span></label>
                                <input type="number" name="current-price" class="input-field mt-1 w-full" placeholder="Ex: 65">
                            </div>
                            <div class="col-span-12 sm:col-span-4 md:col-span-2 flex items-end justify-end">
                                <button type="button" class="remove-product-btn bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600 transition w-full sm:w-auto">Remover</button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button type="button" id="calculator-add-product-btn" class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-md hover:bg-blue-600 transition">
                            + Adicionar Produto
                        </button>
                    </div>
                     <small class="block mt-4 text-slate-500">Nota: O Custo Direto deve incluir todos os custos variáveis por unidade (ex: ingredientes, embalagem, etc.)</small>
                </div>
                <div class="text-center pt-6">
                    <button id="create-panel-btn" class="bg-indigo-600 text-white font-bold text-lg px-8 py-4 rounded-lg hover:bg-indigo-700 transition shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                        Criar meu Painel de Simulação
                    </button>
                </div>
            </main>

            <div id="simulation-panel" class="space-y-8 opacity-0 max-h-0 overflow-hidden">
                <div class="card">
                     <h2 class="text-2xl font-bold mb-4 text-slate-900">Resultado Geral da Simulação</h2>
                     <div id="general-results" class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                        <div class="bg-green-100 p-4 rounded-lg"><p class="text-sm text-green-800 font-medium">Faturamento Total</p><p id="total-revenue-calculator" class="text-2xl font-bold text-green-900">R$ 0,00</p></div>
                        <div class="bg-red-100 p-4 rounded-lg"><p class="text-sm text-red-800 font-medium">Custos Totais</p><p id="total-costs" class="text-2xl font-bold text-red-900">R$ 0,00</p></div>
                        <div class="bg-indigo-100 p-4 rounded-lg"><p class="text-sm text-indigo-800 font-medium">Lucro Livre Final</p><p id="final-profit" class="text-2xl font-bold text-indigo-900">R$ 0,00</p></div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-2xl font-bold mb-4 text-slate-900">Painel Interativo de Produtos</h2>
                    <div id="interactive-cards-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                </div>
                <div class="grid grid-cols-1 gap-8">
                    <div class="card"><h2 class="text-2xl font-bold mb-4 text-slate-900">Análise de Custos por Unidade</h2><div id="unit-cost-analysis" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
                </div>
                <div class="mt-8 text-center">
                    <button id="export-calculator-csv-btn" class="bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-800 flex items-center justify-center mx-auto hidden">
                        <i data-lucide="sheet" class="h-5 w-5 mr-2"></i> Exportar Dados (CSV)
                    </button>
                </div>
            </div>
        </section>
        
        <hr class="my-12 border-slate-300">

        <!-- ================================================================== -->
        <!-- SECÇÃO 3: CÁLCULO DIÁRIO                                       -->
        <!-- ================================================================== -->
        <section id="calculo-diario" class="py-8">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Cálculo Diário de Lucratividade</h1>
                <p class="mt-2 text-md md:text-lg text-slate-600">Acompanhe o resultado de cada dia de trabalho e mantenha o controle financeiro.</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Coluna de Configuração e Lançamento -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Card de Configuração -->
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-900 flex items-center"><i data-lucide="settings-2" class="h-5 w-5 mr-3 text-indigo-600"></i>Configurações Gerais</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-medium text-gray-700 mb-2">Custos Fixos e Variáveis</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="daily-calc-monthly-expenses" class="block text-sm font-medium text-slate-700">Total Despesas Fixas Mensais (R$)</label>
                                        <input type="number" id="daily-calc-monthly-expenses" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2" placeholder="Ex: 5000">
                                    </div>
                                    <div>
                                        <label for="daily-calc-working-days" class="block text-sm font-medium text-slate-700">Dias Úteis no Mês</label>
                                        <input type="number" id="daily-calc-working-days" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2" placeholder="Ex: 26">
                                    </div>
                                </div>
                            </div>
                             <div>
                                <h3 class="text-lg font-medium text-gray-700 mb-2">Taxas sobre Faturamento</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="daily-calc-tax-percentage" class="block text-sm font-medium text-slate-700">Imposto sobre Faturamento (%)</label>
                                        <input type="number" id="daily-calc-tax-percentage" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2" placeholder="Ex: 4">
                                    </div>
                                    <div>
                                        <label for="daily-calc-card-fee-percentage" class="block text-sm font-medium text-slate-700">Taxa Maquininha/App (%)</label>
                                        <input type="number" id="daily-calc-card-fee-percentage" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2" placeholder="Ex: 3.5">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 text-right">
                           <button id="save-daily-config-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center ml-auto btn-save-feedback">
                                <i data-lucide="save" class="h-5 w-5 mr-2"></i>
                                <span class="btn-text">Salvar Configurações</span>
                            </button>
                        </div>
                    </div>

                    <!-- Card do Cardápio -->
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-900 flex items-center"><i data-lucide="book-open" class="h-5 w-5 mr-3 text-indigo-600"></i>Seu Cardápio de Produtos</h2>
                        
                        <!-- Adicionar Manualmente -->
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-gray-800 mb-2">Adicionar Novo Produto Manualmente</h3>
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-2 items-end">
                                <div class="md:col-span-5"><label class="text-sm font-medium">Nome</label><input type="text" id="manual-product-name" placeholder="Nome do Produto" class="w-full p-2 mt-1 border rounded-md"></div>
                                <div class="md:col-span-2"><label class="text-sm font-medium">Custo (R$)</label><input type="number" id="manual-product-cost" placeholder="10.50" class="w-full p-2 mt-1 border rounded-md"></div>
                                <div class="md:col-span-2"><label class="text-sm font-medium">Venda (R$)</label><input type="number" id="manual-product-price" placeholder="25.00" class="w-full p-2 mt-1 border rounded-md"></div>
                                <div class="md:col-span-3"><button id="manual-add-product-btn" class="w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-600">Salvar Produto</button></div>
                            </div>
                        </div>

                        <!-- Importar CSV -->
                        <div class="mt-6">
                             <h3 class="text-lg font-medium text-gray-800 mb-2">Ou Importar Cardápio em Massa</h3>
                            <button id="import-daily-menu-btn" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-600 flex items-center">
                                <i data-lucide="upload-cloud" class="h-5 w-5 mr-2"></i> Importar Cardápio (CSV)
                            </button>
                            <input type="file" id="daily-menu-csv-input" class="hidden" accept=".csv">
                            <div class="csv-instructions text-sm">
                                <p class="font-semibold text-gray-800">Como preparar seu ficheiro CSV:</p>
                                <p class="mt-2 text-gray-600">Crie 3 colunas no seu Excel: `Nome do Produto`, `Custo`, `Preço de Venda`. Sem cabeçalho.</p>
                            </div>
                        </div>

                        <!-- Lista de Produtos -->
                        <div class="mt-6">
                            <h3 class="font-medium text-slate-800 text-lg">Produtos Carregados:</h3>
                            <div id="daily-calc-master-product-list" class="mt-2 text-sm text-slate-600 max-h-48 overflow-y-auto bg-slate-50 p-2 rounded-md space-y-2">
                                <!-- Produtos carregados aqui -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card de Lançamento de Vendas -->
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-900 flex items-center"><i data-lucide="shopping-cart" class="h-5 w-5 mr-3 text-indigo-600"></i>Lançar Vendas do Dia (<span id="current-date-display"></span>)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                            <div class="md:col-span-6">
                                <label for="daily-calc-product-select" class="block text-sm font-medium text-slate-700">Produto Vendido</label>
                                <select id="daily-calc-product-select" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2 bg-white"></select>
                            </div>
                            <div class="md:col-span-3">
                                <label for="daily-calc-quantity" class="block text-sm font-medium text-slate-700">Quantidade</label>
                                <input type="number" id="daily-calc-quantity" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2" value="1">
                            </div>
                            <div class="md:col-span-3">
                                <button id="daily-calc-add-sale" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600 flex items-center justify-center">
                                    <i data-lucide="plus" class="h-5 w-5 mr-2"></i> Adicionar
                                </button>
                            </div>
                        </div>

                        <div class="mt-6">
                            <h3 class="font-medium text-slate-800">Vendas Lançadas Hoje:</h3>
                            <div class="overflow-x-auto mt-2">
                                <table class="min-w-full bg-white border rounded-lg">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th class="text-left py-2 px-3 text-sm font-semibold text-slate-600">Produto</th>
                                            <th class="text-center py-2 px-3 text-sm font-semibold text-slate-600">Qtd.</th>
                                            <th class="text-right py-2 px-3 text-sm font-semibold text-slate-600">Total</th>
                                            <th class="py-2 px-3"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="daily-sales-table-body">
                                        <!-- Vendas do dia serão injetadas aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Despesas Extras e Diaristas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                         <!-- Custo com Diaristas -->
                        <div class="card">
                             <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-900 flex items-center"><i data-lucide="users" class="h-5 w-5 mr-3 text-indigo-600"></i>Custo com Diaristas (Hoje)</h2>
                             <div class="grid grid-cols-2 gap-4 items-end">
                                 <div>
                                    <label class="text-sm font-medium">Nº Diaristas</label>
                                    <input type="number" id="daily-staff-count" placeholder="0" class="w-full p-2 mt-1 border rounded-md">
                                 </div>
                                 <div>
                                    <label class="text-sm font-medium">Custo por Pessoa (R$)</label>
                                    <input type="number" id="daily-staff-cost" placeholder="100" class="w-full p-2 mt-1 border rounded-md">
                                 </div>
                             </div>
                        </div>
                        <!-- Despesas Extras -->
                        <div class="card">
                             <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-900 flex items-center"><i data-lucide="plus-circle" class="h-5 w-5 mr-3 text-indigo-600"></i>Despesas Extras do Dia</h2>
                             <div class="grid grid-cols-12 gap-2 items-end">
                                 <div class="col-span-7"><label class="text-sm font-medium">Descrição</label><input type="text" id="extra-expense-desc" placeholder="Ex: Comida funcionário" class="w-full p-2 mt-1 border rounded-md"></div>
                                 <div class="col-span-5"><label class="text-sm font-medium">Valor (R$)</label><input type="number" id="extra-expense-value" placeholder="20.00" class="w-full p-2 mt-1 border rounded-md"></div>
                             </div>
                            <button id="add-extra-expense-btn" class="w-full mt-3 bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600">Adicionar Despesa Extra</button>
                             <div class="mt-4">
                                 <h3 class="font-medium text-slate-800">Despesas Lançadas:</h3>
                                 <ul id="extra-expenses-list" class="mt-2 text-sm text-slate-600 list-disc list-inside max-h-24 overflow-y-auto bg-slate-50 p-2 rounded-md">
                                     <li class="italic">Nenhuma despesa extra hoje.</li>
                                 </ul>
                             </div>
                        </div>
                    </div>

                </div>

                <!-- Coluna de Resultados e Histórico -->
                <div class="space-y-8">
                    <!-- Card de Resultados do Dia -->
                    <div class="card sticky top-20">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-900 flex items-center"><i data-lucide="bar-chart-2" class="h-5 w-5 mr-3 text-indigo-600"></i>Resumo do Dia</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-blue-50 rounded-md">
                                <span class="text-sm font-medium text-blue-700">Faturamento do Dia</span>
                                <span id="daily-revenue-result" class="font-bold text-blue-800 text-lg">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-orange-50 rounded-md">
                                <span class="text-sm font-medium text-orange-700">(-) Custo dos Produtos</span>
                                <span id="daily-cogs-result" class="font-bold text-orange-800">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-orange-50 rounded-md">
                                <span class="text-sm font-medium text-orange-700">(-) Custo Fixo do Dia</span>
                                <span id="daily-fixed-cost-result" class="font-bold text-orange-800">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-orange-50 rounded-md">
                                <span class="text-sm font-medium text-orange-700">(-) Despesas Variáveis</span>
                                <span id="daily-variable-expenses-result" class="font-bold text-orange-800">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-orange-50 rounded-md">
                                <span class="text-sm font-medium text-orange-700">(-) Custo com Diaristas</span>
                                <span id="daily-staff-total-cost-result" class="font-bold text-orange-800">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-orange-50 rounded-md">
                                <span class="text-sm font-medium text-orange-700">(-) Despesas Extras</span>
                                <span id="daily-extra-expenses-total-result" class="font-bold text-orange-800">R$ 0,00</span>
                            </div>
                            <div id="daily-profit-loss-card" class="p-4 rounded-lg text-center transition-colors duration-300 mt-3">
                                <p class="text-lg font-bold uppercase">(=) Resultado do Dia</p>
                                <p id="daily-profit-loss-result" class="text-4xl font-extrabold mt-1">R$ 0,00</p>
                            </div>
                             <div class="mt-4">
                                <button id="export-daily-report-btn" class="w-full bg-gray-700 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-800 flex items-center justify-center">
                                    <i data-lucide="download" class="h-5 w-5 mr-2"></i>
                                    Baixar Relatório do Dia (CSV)
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Card de Histórico -->
                     <div class="card">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-900 flex items-center"><i data-lucide="history" class="h-5 w-5 mr-3 text-indigo-600"></i>Histórico de Fechamentos</h2>
                        <div id="daily-calc-history-log" class="space-y-3 max-h-96 overflow-y-auto">
                           <p class="text-sm text-slate-500 italic">Nenhum histórico salvo ainda.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </div>
    
    <footer class="mt-12 mb-8">
        <div class="max-w-4xl mx-auto px-4">
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <h3 class="text-xl font-bold text-gray-800">Quer trocar uma ideia sobre seu negócio?</h3>
                <p class="text-gray-600 mt-2 mb-4">Vamos conversar sobre como otimizar seus resultados.</p>
                <a href="https://wa.me/5567999093031" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-transform transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 mr-2"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"></path></svg>
                    Fala comigo!
                </a>
            </div>
        </div>
    </footer>

    <!-- SCRIPTS DEVEM FICAR NO FINAL DO BODY -->
    <!-- Script para o ANALISADOR DE LUCRATIVIDADE -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const section = document.querySelector('#analisador');
            if (!section) return;

            let compositionChart = null, overviewChart = null, lastCalculationData = {};
            lucide.createIcons();
            
            const productList = section.querySelector('#analisador-product-list');
            const addProductBtn = section.querySelector('#analisador-add-product-btn');
            const fixedExpensesList = section.querySelector('#fixed-expenses-list');
            const addExpenseBtn = section.querySelector('#add-expense-btn');
            const productTemplate = productList.children[0].cloneNode(true);

            // --- LÓGICA DE IMPORTAÇÃO CSV ---
            const importProductsBtn = section.querySelector('#import-products-btn');
            const productsCsvInput = section.querySelector('#products-csv-input');
            const importExpensesBtn = section.querySelector('#import-expenses-btn');
            const expensesCsvInput = section.querySelector('#expenses-csv-input');

            importProductsBtn.addEventListener('click', () => productsCsvInput.click());
            importExpensesBtn.addEventListener('click', () => expensesCsvInput.click());

            productsCsvInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    parseProductsCSV(e.target.result);
                };
                reader.readAsText(file);
                event.target.value = ''; // Limpar para permitir re-importação do mesmo ficheiro
            });

            expensesCsvInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    parseExpensesCSV(text);
                };
                reader.readAsText(file);
                event.target.value = ''; // Limpar
            });

            function parseProductsCSV(csvText) {
                const rows = csvText.split('\n').filter(row => row.trim() !== '');
                
                const existingProductRows = productList.querySelectorAll('.product-item');
                existingProductRows.forEach(row => row.remove());

                rows.forEach((rowText) => {
                    const cols = rowText.split(/[,;]/).map(s => s.trim());
                    if (cols.length < 4) return;
                    
                    const newRow = productTemplate.cloneNode(true);
                    newRow.querySelector('[data-field="name"]').value = cols[0] || '';
                    newRow.querySelector('[data-field="cost"]').value = cols[1] || '';
                    newRow.querySelector('[data-field="price"]').value = cols[2] || '';
                    newRow.querySelector('[data-field="quantity"]').value = cols[3] || '';
                    productList.appendChild(newRow);
                });
                lucide.createIcons();
            }

            function parseExpensesCSV(csvText) {
                const rows = csvText.split('\n').filter(row => row.trim() !== '');
                const otherExpensesContainer = section.querySelector('#fixed-expenses-list');
                const existingOtherExpenses = new Set();
                
                otherExpensesContainer.querySelectorAll('.expense-item [data-field="name"]').forEach(item => {
                    existingOtherExpenses.add(item.value.toLowerCase());
                });

                rows.forEach(rowText => {
                    const cols = rowText.split(/[,;]/).map(s => s.trim());
                    if (cols.length < 2) return;
                    
                    const name = cols[0];
                    const value = cols[1];
                    let found = false;

                    section.querySelectorAll('[data-label], [data-key]').forEach(input => {
                        const key = input.getAttribute('data-label') || input.getAttribute('data-key');
                        if (key && key.toLowerCase() === name.toLowerCase()) {
                            input.value = value;
                            found = true;
                        }
                    });

                    if (!found && !existingOtherExpenses.has(name.toLowerCase())) {
                        const newExpenseRow = createExpenseTemplate();
                        newExpenseRow.querySelector('[data-field="name"]').value = name;
                        newExpenseRow.querySelector('[data-field="value"]').value = value;
                        otherExpensesContainer.appendChild(newExpenseRow);
                    }
                });
                 lucide.createIcons();
            }


            const createExpenseTemplate = () => {
                const div = document.createElement('div');
                div.className = "expense-item grid grid-cols-12 gap-2 items-center";
                div.innerHTML = `<input type="text" placeholder="Nome da despesa" class="col-span-6 p-2 border rounded-md" data-field="name"><input type="number" placeholder="Valor (R$)" class="col-span-4 p-2 border rounded-md" data-field="value"><button class="remove-expense-btn bg-red-100 text-red-600 p-2 rounded-md hover:bg-red-200 col-span-2 flex items-center justify-center"><i data-lucide="trash-2" class="h-5 w-5"></i></button>`;
                return div;
            };
            const expenseTemplate = createExpenseTemplate();
            
            addProductBtn.addEventListener('click', () => {
                const newProductRow = productTemplate.cloneNode(true);
                newProductRow.querySelectorAll('input').forEach(input => input.value = '');
                productList.appendChild(newProductRow);
                lucide.createIcons();
            });

            productList.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-product-btn');
                if (removeBtn && productList.children.length > 1) removeBtn.closest('.product-item').remove();
            });

            addExpenseBtn.addEventListener('click', () => {
                const newExpenseRow = expenseTemplate.cloneNode(true);
                fixedExpensesList.appendChild(newExpenseRow);
                lucide.createIcons();
            });

            fixedExpensesList.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-expense-btn');
                if (removeBtn) removeBtn.closest('.expense-item').remove();
            });
            
            const calculateBtn = section.querySelector('#calculate-btn');
            const resultSection = section.querySelector('#result-section');
            const errorMessageDiv = section.querySelector('#error-message');
            const geminiBtn = section.querySelector('#gemini-analysis-btn');
            const geminiResultContainer = section.querySelector('#gemini-result-container');
            const exportCsvBtn = section.querySelector('#export-analyzer-csv-btn');

            const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const formatNumber = (value) => (value || 0).toLocaleString('pt-BR');
            const getNumericValue = (id) => parseFloat(section.querySelector(`#${id}`).value) || 0;
            
            function showError(message) {
                errorMessageDiv.textContent = message;
                errorMessageDiv.classList.remove('hidden');
                resultSection.classList.add('hidden');
            }

            calculateBtn.addEventListener('click', () => {
                errorMessageDiv.classList.add('hidden');
                let isValid = true;
                let productData = [];
                let totalRevenue = 0, totalCogs = 0;
                
                productList.querySelectorAll('.product-item').forEach(item => {
                    const name = item.querySelector('[data-field="name"]').value || 'Produto sem nome';
                    const cost = parseFloat(item.querySelector('[data-field="cost"]').value);
                    const price = parseFloat(item.querySelector('[data-field="price"]').value);
                    const quantity = parseFloat(item.querySelector('[data-field="quantity"]').value);
                    if (isNaN(cost) || isNaN(price) || isNaN(quantity) || cost < 0 || price < 0 || quantity < 0) isValid = false;
                    totalRevenue += price * quantity;
                    totalCogs += cost * quantity;
                    productData.push({ name, cost, price, quantity, profit_per_unit: price - cost });
                });
                
                let fixedExpensesInputs = section.querySelectorAll('[data-label]');
                let otherFixedExpenses = [];
                let fixedExpenses = 0;
                fixedExpensesInputs.forEach(input => fixedExpenses += parseFloat(input.value) || 0);

                fixedExpensesList.querySelectorAll('.expense-item').forEach(item => {
                    const name = item.querySelector('[data-field="name"]').value || 'Outra Despesa';
                    const value = parseFloat(item.querySelector('[data-field="value"]').value) || 0;
                    if (value > 0) {
                        fixedExpenses += value;
                        otherFixedExpenses.push({ name, value });
                    }
                });

                const taxesPercentage = getNumericValue('taxesPercentage');
                const feesPercentage = getNumericValue('feesPercentage');
                const wastePercentage = getNumericValue('wastePercentage');

                if (!isValid) return showError("Preencha todos os campos dos produtos com valores válidos.");
                if (totalRevenue <= 0) return showError("O faturamento deve ser maior que zero. Verifique preços e quantidades.");
                
                const variableExpensesPercentage = taxesPercentage + feesPercentage + wastePercentage;
                const variableExpensesValue = totalRevenue * (variableExpensesPercentage / 100);
                const totalExpenses = fixedExpenses + variableExpensesValue;
                const grossProfit = totalRevenue - totalCogs;
                const netProfit = grossProfit - totalExpenses;
                const breakEvenPoint = (totalRevenue - totalCogs - variableExpensesValue) > 0 ? fixedExpenses / ((totalRevenue - totalCogs - variableExpensesValue) / totalRevenue) : 0;
                
                lastCalculationData = { productData, totalRevenue, totalCogs, fixedExpenses, fixedExpensesInputs, otherFixedExpenses, variableExpensesValue, totalExpenses, netProfit, breakEvenPoint, taxesPercentage, feesPercentage, wastePercentage };

                section.querySelector('#total-revenue-analyzer').textContent = formatCurrency(totalRevenue);
                section.querySelector('#total-cogs').textContent = formatCurrency(totalCogs);
                section.querySelector('#gross-profit').textContent = formatCurrency(grossProfit);
                section.querySelector('#gross-profit-margin').textContent = `Margem de ${(grossProfit / totalRevenue * 100).toFixed(2)}%`;
                section.querySelector('#total-expenses').textContent = formatCurrency(totalExpenses);
                section.querySelector('#expenses-breakdown').textContent = `Fixas: ${formatCurrency(fixedExpenses)} | Variáveis: ${formatCurrency(variableExpensesValue)}`;
                section.querySelector('#break-even').textContent = formatCurrency(breakEvenPoint);
                const profitLossMessage = section.querySelector('#profit-loss-message');
                section.querySelector('#net-profit').textContent = formatCurrency(netProfit);
                
                resultSection.classList.remove('hidden');
                
                if (netProfit >= 0) {
                    profitLossMessage.className = 'p-4 rounded-lg text-center text-xl font-bold mb-6 bg-green-100 text-green-800';
                    profitLossMessage.textContent = "Parabéns! Sua operação está dando lucro.";
                } else {
                    profitLossMessage.className = 'p-4 rounded-lg text-center text-xl font-bold mb-6 bg-red-100 text-red-800';
                    profitLossMessage.textContent = "Atenção! Sua operação está gerando prejuízo.";
                }

                updateCharts({ totalCogs, totalExpenses, netProfit, totalRevenue, breakEvenPoint });
                geminiResultContainer.classList.add('hidden'); 
                window.scrollTo({ top: resultSection.offsetTop - 80, behavior: 'smooth' });
            });

            function updateCharts(data) {
                if (compositionChart) compositionChart.destroy();
                if (overviewChart) overviewChart.destroy();
                const compositionCtx = section.querySelector('#compositionChart').getContext('2d');
                compositionChart = new Chart(compositionCtx, {
                    type: 'doughnut', data: {
                        labels: ['Custo Produtos (CMV)', 'Despesas', 'Lucro Líquido'],
                        datasets: [{ data: [data.totalCogs, data.totalExpenses, data.netProfit > 0 ? data.netProfit : 0], backgroundColor: ['#f97316', '#ef4444', '#16a34a'] }]
                    }, options: { plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.raw)}` } } } }
                });
                const overviewCtx = section.querySelector('#overviewChart').getContext('2d');
                overviewChart = new Chart(overviewCtx, {
                    type: 'bar', data: {
                        labels: ['Valores Totais'],
                        datasets: [
                            { label: 'Faturamento Bruto', data: [data.totalRevenue], backgroundColor: '#3b82f6' },
                            { label: 'Custos + Despesas', data: [data.totalCogs + data.totalExpenses], backgroundColor: '#ef4444' },
                            { label: 'Ponto de Equilíbrio', data: [data.breakEvenPoint], backgroundColor: '#8b5cf6' }
                        ]
                    }, options: { scales: { y: { ticks: { callback: (v) => formatCurrency(v) } } }, plugins: { tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${formatCurrency(c.raw)}` } } } }
                });
            }
            
            geminiBtn.addEventListener('click', async () => {
                if (Object.keys(lastCalculationData).length === 0) {
                    showError("Por favor, calcule a lucratividade primeiro antes de gerar a análise.");
                    return;
                }
                const geminiLoader = section.querySelector('#gemini-loader');
                const geminiBtnText = section.querySelector('#gemini-btn-text');
                geminiLoader.classList.remove('hidden');
                geminiBtnText.classList.add('hidden');
                geminiBtn.disabled = true;
                geminiResultContainer.classList.add('hidden');

                const prompt = `Você é um consultor financeiro especialista em restaurantes e pequenos negócios de alimentação no Brasil. Analise os seguintes dados financeiros mensais de um restaurante e forneça um diagnóstico e recomendações. DADOS FINANCEIROS: - Faturamento Bruto: ${formatCurrency(lastCalculationData.totalRevenue)} - Custo dos Produtos Vendidos (CMV): ${formatCurrency(lastCalculationData.totalCogs)} - Despesas Fixas: ${formatCurrency(lastCalculationData.fixedExpenses)} - Despesas Variáveis: ${formatCurrency(lastCalculationData.variableExpensesValue)} - Lucro Líquido Final: ${formatCurrency(lastCalculationData.netProfit)} - Ponto de Equilíbrio: ${formatCurrency(lastCalculationData.breakEvenPoint)} - Detalhes dos Produtos: ${JSON.stringify(lastCalculationData.productData, null, 2)} TAREFA: Crie um relatório conciso com as seguintes seções: 1. **Diagnóstico Rápido:** Um parágrafo resumindo a saúde financeira geral do negócio, mencionando o resultado (lucro ou prejuízo) e a margem líquida. 2. **Pontos Fortes:** Uma lista com 2 ou 3 pontos positivos, como os produtos mais vendidos ou mais lucrativos. 3. **Pontos de Atenção:** Uma lista com 2 ou 3 pontos que precisam de melhoria, como custos elevados ou produtos com baixa performance. 4. **Recomendações Acionáveis:** Uma lista de 3 a 5 sugestões práticas e diretas para aumentar a lucratividade. As sugestões podem envolver preços, marketing, controle de custos ou otimização do cardápio. Use um tom profissional, mas encorajador. Formate a resposta usando Markdown simples.`;

                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = ""; 

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         const errorBody = await response.json();
                         console.error("Erro da API:", errorBody);
                         throw new Error(`Erro na API: ${response.statusText} - ${errorBody.error.message}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0 && result.candidates[0].content.parts[0].text) {
                        const analysisText = result.candidates[0].content.parts[0].text;
                        geminiResultContainer.innerHTML = simpleMarkdownToHtml(analysisText);
                        geminiResultContainer.classList.remove('hidden');
                    } else {
                        console.error("Resposta da API inválida ou bloqueada:", JSON.stringify(result, null, 2));
                        throw new Error("A resposta da API não continha o texto esperado. Isso pode acontecer devido a filtros de segurança ou um erro inesperado.");
                    }
                } catch (error) {
                    console.error("Erro completo no bloco catch:", error);
                    geminiResultContainer.innerHTML = `<p class="text-red-600">Ocorreu um erro ao gerar a análise. Verifique se a Chave da API está correta e tente novamente. <br><br><strong>Detalhe técnico:</strong> ${error.message}</p>`;
                    geminiResultContainer.classList.remove('hidden');
                } finally {
                    geminiLoader.classList.add('hidden');
                    geminiBtnText.classList.remove('hidden');
                    geminiBtn.disabled = false;
                }
            });

            function simpleMarkdownToHtml(text) {
                 if (typeof text !== 'string' || !text) {
                     return '<p>Nenhuma análise de texto recebida da IA.</p>';
                 }
                let html = text
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                    .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                    .replace(/\*(.*)\*/gim, '<em>$1</em>')
                    .replace(/^\s*\n\*/gm, '<ul>\n*')
                    .replace(/^(\*.+)\s*\n([^*])/gm, '$1\n</ul>\n$2')
                    .replace(/^\* (.*$)/gim, '<li>$1</li>');
                
                return html.split('\n').map(p => p.startsWith('<') || p.trim() === '' ? p : `<p>${p}</p>`).join('');
             }
            
            exportCsvBtn.addEventListener('click', () => {
                if (Object.keys(lastCalculationData).length === 0) return alert("Calcule a lucratividade primeiro.");
                
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Relatorio de Analise de Lucratividade\n\n";
                
                csvContent += "Resumo Financeiro\n";
                csvContent += `Faturamento Bruto;${formatNumber(lastCalculationData.totalRevenue)}\n`;
                csvContent += `Custo dos Produtos (CMV);${formatNumber(lastCalculationData.totalCogs)}\n`;
                csvContent += `Lucro Bruto;${formatNumber(lastCalculationData.totalRevenue - lastCalculationData.totalCogs)}\n`;
                csvContent += `Despesas Fixas Totais;${formatNumber(lastCalculationData.fixedExpenses)}\n`;
                csvContent += `Despesas Variaveis Totais;${formatNumber(lastCalculationData.variableExpensesValue)}\n`;
                csvContent += `Total de Despesas;${formatNumber(lastCalculationData.totalExpenses)}\n`;
                csvContent += `Resultado Final (Lucro/Prejuizo);${formatNumber(lastCalculationData.netProfit)}\n`;
                csvContent += `Ponto de Equilibrio;${formatNumber(lastCalculationData.breakEvenPoint)}\n\n`;

                csvContent += "Detalhes dos Produtos\n";
                csvContent += "Nome;Custo Unitario;Preco de Venda;Qtd Vendida;Receita Total;Lucro Total do Produto\n";
                lastCalculationData.productData.forEach(p => {
                    const row = [p.name, formatNumber(p.cost), formatNumber(p.price), p.quantity, formatNumber(p.price * p.quantity), formatNumber((p.price - p.cost) * p.quantity)].join(";");
                    csvContent += row + "\n";
                });
                csvContent += "\n";
                
                csvContent += "Detalhes das Despesas\n";
                csvContent += "Tipo;Item;Valor\n";
                lastCalculationData.fixedExpensesInputs.forEach(input => {
                    const label = input.getAttribute('data-label') || 'Despesa';
                    const value = parseFloat(input.value) || 0;
                    if (value > 0) csvContent += `Fixa;${label};${formatNumber(value)}\n`;
                });
                lastCalculationData.otherFixedExpenses.forEach(expense => csvContent += `Fixa;${expense.name};${formatNumber(expense.value)}\n`);
                csvContent += `Variavel (%);Impostos (%);${lastCalculationData.taxesPercentage}\n`;
                csvContent += `Variavel (%);Taxas (%);${lastCalculationData.feesPercentage}\n`;
                csvContent += `Variavel (%);Perdas (%);${lastCalculationData.wastePercentage}\n`;
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "analise_lucratividade.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });
    </script>
    
    <!-- Script para a CALCULADORA DE PREÇOS -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const section = document.querySelector('#calculadora');
            if (!section) return;

            const addProductBtn = section.querySelector('#calculator-add-product-btn');
            const productList = section.querySelector('#calculator-product-list');
            const productTemplate = section.querySelector('#product-template');
            const createPanelBtn = section.querySelector('#create-panel-btn');
            const simulationPanel = section.querySelector('#simulation-panel');
            const interactiveCardsContainer = section.querySelector('#interactive-cards-container');
            const unitCostAnalysis = section.querySelector('#unit-cost-analysis');
            const exportCsvBtn = section.querySelector('#export-calculator-csv-btn');
            const importBtn = section.querySelector('#import-calculator-products-btn');
            const csvInput = section.querySelector('#calculator-csv-input');


            let lastSimulationData = {};

            const formatCurrency = (value) => !isNaN(value) && isFinite(value) ? value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00';
            const formatNumber = (value) => (value || 0).toLocaleString('pt-BR');
            const parseInput = (value, isFloat = true) => (isFloat ? parseFloat(value) : parseInt(value, 10)) || 0;
            
            // --- LÓGICA DE IMPORTAÇÃO CSV PARA CALCULADORA ---
            importBtn.addEventListener('click', () => csvInput.click());
            csvInput.addEventListener('change', event => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => parseCalculatorProductsCSV(e.target.result);
                reader.readAsText(file);
                event.target.value = '';
            });

            function parseCalculatorProductsCSV(csvText) {
                const rows = csvText.split('\n').filter(row => row.trim() !== '');
                
                const existingProductRows = productList.querySelectorAll('.grid:not(#product-template)');
                existingProductRows.forEach(row => row.remove());

                rows.forEach((rowText) => {
                    const cols = rowText.split(/[,;]/).map(s => s.trim());
                    if (cols.length < 3) return; // Precisa pelo menos Nome, Custo, Meta
                    
                    const newRow = productTemplate.cloneNode(true);
                    newRow.style.display = 'grid';
                    newRow.removeAttribute('id');
                    newRow.querySelectorAll('input').forEach(input => input.classList.add('p-2', 'rounded-md', 'border-slate-300', 'shadow-sm', 'w-full'));

                    newRow.querySelector('[name="product-name"]').value = cols[0] || '';
                    newRow.querySelector('[name="direct-cost"]').value = cols[1] || '';
                    newRow.querySelector('[name="sales-goal"]').value = cols[2] || '';
                    newRow.querySelector('[name="current-price"]').value = cols[3] || ''; // Opcional

                    productList.appendChild(newRow);
                });
            }


            const addNewProduct = () => {
                const newProductRow = productTemplate.cloneNode(true);
                newProductRow.style.display = 'grid';
                newProductRow.removeAttribute('id');
                newProductRow.querySelectorAll('input').forEach(input => input.classList.add('p-2', 'rounded-md', 'border-slate-300', 'shadow-sm', 'w-full'));
                productList.appendChild(newProductRow);
            };

            productList.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-product-btn');
                if (removeBtn && productList.querySelectorAll('.grid:not(#product-template)').length > 1) removeBtn.closest('.grid').remove();
            });

            const updateSimulation = () => {
                const fixedCosts = parseInput(section.querySelector('#fixed-costs').value);
                const variableCostsPercent = parseInput(section.querySelector('#variable-costs').value) / 100;
                const profitGoal = parseInput(section.querySelector('#profit-goal').value);
                
                let productsData = [];
                interactiveCardsContainer.querySelectorAll('.product-card').forEach((card) => {
                    const id = card.dataset.productId;
                    const name = card.querySelector('.product-name').textContent;
                    const directCost = parseInput(card.dataset.directCost);
                    const salesGoal = parseInput(card.querySelector(`[name="sales-goal-${id}"]`).value, false);
                    const sellingPrice = parseInput(card.querySelector(`[name="selling-price-${id}"]`).value);
                    productsData.push({ id, name, directCost, salesGoal, sellingPrice });
                });

                const totalUnitsSold = productsData.reduce((sum, p) => sum + p.salesGoal, 0);
                const totalRevenue = productsData.reduce((sum, p) => sum + (p.salesGoal * p.sellingPrice), 0);
                const totalDirectCosts = productsData.reduce((sum, p) => sum + (p.salesGoal * p.directCost), 0);
                const totalVariableCostsBasedOnRevenue = totalRevenue * variableCostsPercent;
                const totalCosts = fixedCosts + totalDirectCosts + totalVariableCostsBasedOnRevenue;
                const finalProfit = totalRevenue - totalCosts;

                section.querySelector('#total-revenue-calculator').textContent = formatCurrency(totalRevenue);
                section.querySelector('#total-costs').textContent = formatCurrency(totalCosts);
                section.querySelector('#final-profit').textContent = formatCurrency(finalProfit);

                productsData.forEach(p => {
                    section.querySelector(`#product-revenue-${p.id}`).textContent = formatCurrency(p.salesGoal * p.sellingPrice);
                });

                let analysisData = [];
                if (totalUnitsSold > 0 && (1 - variableCostsPercent) > 0) {
                    const fixedCostPerUnit = fixedCosts / totalUnitsSold;
                    const analysisHTML = productsData.map(p => {
                        const breakEvenPrice = (p.directCost + fixedCostPerUnit) / (1 - variableCostsPercent);
                        analysisData.push({name: p.name, breakEvenPrice});
                        return `
                            <div class="border p-4 rounded-lg space-y-3 bg-white">
                                <h4 class="font-bold text-lg text-slate-800">${p.name}</h4>
                                <div class="highlight-card p-4 rounded-lg text-center">
                                    <h5 class="font-semibold text-yellow-800">Ponto de Equilíbrio por Unidade</h5>
                                    <p class="font-bold text-yellow-900 text-2xl mt-1">${formatCurrency(breakEvenPrice)}</p>
                                    <p class="text-xs text-yellow-700 mt-1">(Preço mínimo para cobrir todos os custos)</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                    unitCostAnalysis.innerHTML = analysisHTML;
                } else {
                     unitCostAnalysis.innerHTML = '<p class="text-slate-500">Dados insuficientes.</p>';
                }

                lastSimulationData = { fixedCosts, variableCostsPercent, profitGoal, productsData, totalRevenue, totalCosts, finalProfit, analysisData };
            };

            const initializePanel = () => {
                interactiveCardsContainer.innerHTML = '';
                const productRows = productList.querySelectorAll('.grid:not(#product-template)');
                if (productRows.length === 0) return alert('Adicione pelo menos um produto.');
                
                productRows.forEach((row, index) => {
                    const id = `p${index}`, name = row.querySelector('[name="product-name"]').value || `Produto ${index + 1}`,
                          directCost = row.querySelector('[name="direct-cost"]').value, salesGoal = row.querySelector('[name="sales-goal"]').value,
                          currentPrice = row.querySelector('[name="current-price"]').value;
                    const card = document.createElement('div');
                    card.className = "product-card border rounded-lg p-4 space-y-3 bg-slate-50";
                    card.dataset.productId = id; card.dataset.directCost = directCost;
                    card.innerHTML = `
                        <h3 class="product-name font-bold text-lg text-slate-800 truncate">${name}</h3>
                        <div><label class="text-sm font-medium">Meta Vendas (Unid.)</label><input type="number" name="sales-goal-${id}" value="${salesGoal}" class="w-full p-2 rounded border"></div>
                        <div><label class="text-sm font-medium">Preço de Venda (R$)</label><input type="number" name="selling-price-${id}" value="${currentPrice}" class="w-full p-2 rounded border"></div>
                        <div class="bg-white p-2 rounded-md text-center mt-2"><p class="text-sm">Receita do Produto</p><p class="font-semibold text-lg text-green-700" id="product-revenue-${id}">-</p></div>`;
                    interactiveCardsContainer.appendChild(card);
                });
                simulationPanel.style.maxHeight = simulationPanel.scrollHeight + 1000 + 'px';
                simulationPanel.style.opacity = '1';
                exportCsvBtn.classList.remove('hidden');
                lucide.createIcons();
                simulationPanel.scrollIntoView({ behavior: 'smooth' });
                updateSimulation();
            };
            
            addProductBtn.addEventListener('click', addNewProduct);
            createPanelBtn.addEventListener('click', initializePanel);
            simulationPanel.addEventListener('input', (e) => { if(e.target.tagName === 'INPUT') updateSimulation(); });
            
            exportCsvBtn.addEventListener('click', () => {
                if (Object.keys(lastSimulationData).length === 0) return alert("Crie um painel de simulação primeiro.");

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Relatorio - Calculadora de Preco por Meta de Vendas\n\n";

                csvContent += "Entradas Principais\n";
                csvContent += `Despesas Fixas Mensais;${formatNumber(lastSimulationData.fixedCosts)}\n`;
                csvContent += `Despesas Variaveis (%);${(lastSimulationData.variableCostsPercent * 100).toFixed(2)}%\n`;
                csvContent += `Meta de Lucro Desejado;${formatNumber(lastSimulationData.profitGoal)}\n\n`;

                csvContent += "Resultado Geral da Simulacao\n";
                csvContent += `Faturamento Total;${formatNumber(lastSimulationData.totalRevenue)}\n`;
                csvContent += `Custos Totais;${formatNumber(lastSimulationData.totalCosts)}\n`;
                csvContent += `Lucro Livre Final;${formatNumber(lastSimulationData.finalProfit)}\n\n`;

                csvContent += "Produtos Simulados e Ponto de Equilibrio\n";
                csvContent += "Produto;Custo Direto;Meta Vendas;Preco Simulado;Receita;Ponto de Equilibrio Unitario\n";
                lastSimulationData.productsData.forEach(p => {
                    const analysis = lastSimulationData.analysisData.find(a => a.name === p.name);
                    const row = [p.name, formatNumber(p.directCost), p.salesGoal, formatNumber(p.sellingPrice), formatNumber(p.salesGoal * p.sellingPrice), analysis ? formatNumber(analysis.breakEvenPrice) : 'N/A'].join(";");
                    csvContent += row + "\n";
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "calculadora_precos_simulacao.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            addNewProduct();
        });
    </script>

    <!-- Script para o CÁLCULO DIÁRIO (NOVO E ATUALIZADO) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const section = document.querySelector('#calculo-diario');
            if (!section) return;

            // --- Elementos da UI ---
            const saveConfigBtn = section.querySelector('#save-daily-config-btn');
            const monthlyExpensesInput = section.querySelector('#daily-calc-monthly-expenses');
            const workingDaysInput = section.querySelector('#daily-calc-working-days');
            const taxPercentageInput = section.querySelector('#daily-calc-tax-percentage');
            const cardFeePercentageInput = section.querySelector('#daily-calc-card-fee-percentage');
            
            const importMenuBtn = section.querySelector('#import-daily-menu-btn');
            const menuCsvInput = section.querySelector('#daily-menu-csv-input');
            const manualProductName = section.querySelector('#manual-product-name');
            const manualProductCost = section.querySelector('#manual-product-cost');
            const manualProductPrice = section.querySelector('#manual-product-price');
            const manualAddProductBtn = section.querySelector('#manual-add-product-btn');
            const masterProductListContainer = section.querySelector('#daily-calc-master-product-list');
            
            const productSelect = section.querySelector('#daily-calc-product-select');
            const quantityInput = section.querySelector('#daily-calc-quantity');
            const addSaleBtn = section.querySelector('#daily-calc-add-sale');
            const salesTableBody = section.querySelector('#daily-sales-table-body');
            
            const staffCountInput = section.querySelector('#daily-staff-count');
            const staffCostInput = section.querySelector('#daily-staff-cost');
            
            const extraExpenseDescInput = section.querySelector('#extra-expense-desc');
            const extraExpenseValueInput = section.querySelector('#extra-expense-value');
            const addExtraExpenseBtn = section.querySelector('#add-extra-expense-btn');
            const extraExpensesListUl = section.querySelector('#extra-expenses-list');
            
            const historyLogContainer = section.querySelector('#daily-calc-history-log');
            const exportDailyReportBtn = section.querySelector('#export-daily-report-btn');

            // --- Elementos de resultado ---
            const dailyFixedCostEl = section.querySelector('#daily-fixed-cost-result');
            const dailyRevenueEl = section.querySelector('#daily-revenue-result');
            const dailyCogsEl = section.querySelector('#daily-cogs-result');
            const dailyVariableExpensesEl = section.querySelector('#daily-variable-expenses-result');
            const dailyStaffTotalCostEl = section.querySelector('#daily-staff-total-cost-result');
            const dailyExtraExpensesTotalEl = section.querySelector('#daily-extra-expenses-total-result');
            const profitLossCard = section.querySelector('#daily-profit-loss-card');
            const profitLossResultEl = section.querySelector('#daily-profit-loss-result');
            
            const currentDate = new Date().toLocaleDateString('pt-BR');
            section.querySelector('#current-date-display').textContent = currentDate;
            const todayKey = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD

            const STORAGE_KEY = 'dailyCalculatorData_v3'; // Nova chave para evitar conflito

            // --- Estrutura de dados ---
            const getDefaultData = () => ({
                config: {
                    monthlyExpenses: '',
                    workingDays: 26,
                    taxPercentage: '',
                    cardFeePercentage: ''
                },
                masterProducts: [],
                dailyLogs: {}, 
            });

            let data = getDefaultData();

            const formatCurrency = (value) => !isNaN(value) ? value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00';
            const parseValue = (value) => parseFloat(String(value).replace(',', '.')) || 0;

            // --- Gerenciamento de Dados (localStorage) ---
            function saveData() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                } catch (e) {
                    console.error("Erro ao salvar dados no localStorage:", e);
                    alert("Não foi possível salvar os dados. O armazenamento pode estar cheio.");
                }
            }

            function loadData() {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        data = { ...getDefaultData(), ...parsedData };
                        data.config = { ...getDefaultData().config, ...parsedData.config };
                        data.dailyLogs = parsedData.dailyLogs || {};
                    } catch (e) {
                        console.error("Erro ao carregar dados, redefinindo para o padrão.", e);
                        data = getDefaultData();
                    }
                }
                if (!data.dailyLogs[todayKey]) {
                    data.dailyLogs[todayKey] = { sales: [], extraExpenses: [], staff: { count: '', cost: '' } };
                }
                updateUIFromData();
            }

            // --- Atualização da Interface do Usuário ---
            function updateUIFromData() {
                monthlyExpensesInput.value = data.config.monthlyExpenses;
                workingDaysInput.value = data.config.workingDays;
                taxPercentageInput.value = data.config.taxPercentage;
                cardFeePercentageInput.value = data.config.cardFeePercentage;
                renderMasterProductList();
                populateProductSelect();
                const todayLog = data.dailyLogs[todayKey];
                staffCountInput.value = todayLog.staff.count;
                staffCostInput.value = todayLog.staff.cost;
                renderDailySalesTable();
                renderExtraExpensesList();
                renderHistory();
                calculateAndDisplaySummary();
            }

            function renderMasterProductList() {
                masterProductListContainer.innerHTML = '';
                if (data.masterProducts.length === 0) {
                    masterProductListContainer.innerHTML = '<p class="italic text-slate-500 p-2">Nenhum produto cadastrado.</p>';
                    return;
                }
                data.masterProducts.forEach((p, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 bg-white rounded-md border';
                    div.innerHTML = `
                        <span>${p.name} (Custo: ${formatCurrency(p.cost)}, Venda: ${formatCurrency(p.price)})</span>
                        <button class="remove-master-product-btn text-red-500 hover:text-red-700" data-index="${index}">
                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                        </button>
                    `;
                    masterProductListContainer.appendChild(div);
                });
                lucide.createIcons();
            }

            function populateProductSelect() {
                productSelect.innerHTML = '<option value="">-- Selecione um produto --</option>';
                const canSell = data.masterProducts.length > 0;
                addSaleBtn.disabled = !canSell;
                productSelect.disabled = !canSell;
                data.masterProducts.forEach((p, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = p.name;
                    productSelect.appendChild(option);
                });
            }

            function renderDailySalesTable() {
                salesTableBody.innerHTML = '';
                const todaySales = data.dailyLogs[todayKey].sales;
                if(todaySales.length === 0) {
                     salesTableBody.innerHTML = `<tr><td colspan="4" class="text-center italic text-slate-500 p-4">Nenhuma venda lançada hoje.</td></tr>`;
                     return;
                }
                todaySales.forEach((sale, index) => {
                    const product = data.masterProducts.find(p => p.name === sale.name);
                    const totalSale = product ? product.price * sale.quantity : 0;
                    const tr = document.createElement('tr');
                    tr.className = 'border-b';
                    tr.innerHTML = `
                        <td class="py-2 px-3">${sale.name}</td>
                        <td class="text-center py-2 px-3">${sale.quantity}</td>
                        <td class="text-right py-2 px-3 font-medium">${formatCurrency(totalSale)}</td>
                        <td class="text-center py-2 px-3">
                            <button class="remove-sale-btn text-red-500 hover:text-red-700" data-index="${index}">
                                <i data-lucide="x-circle" class="h-5 w-5"></i>
                            </button>
                        </td>
                    `;
                    salesTableBody.appendChild(tr);
                });
                lucide.createIcons();
            }

            function renderExtraExpensesList() {
                extraExpensesListUl.innerHTML = '';
                const todayExtraExpenses = data.dailyLogs[todayKey].extraExpenses;
                if(todayExtraExpenses.length === 0) {
                    extraExpensesListUl.innerHTML = `<li class="italic">Nenhuma despesa extra hoje.</li>`;
                    return;
                }
                todayExtraExpenses.forEach((expense, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center';
                    li.innerHTML = `
                        <span>${expense.desc}: ${formatCurrency(expense.value)}</span>
                        <button class="remove-extra-expense-btn text-red-500 hover:text-red-700" data-index="${index}">
                            <i data-lucide="x-circle" class="h-4 w-4"></i>
                        </button>
                    `;
                    extraExpensesListUl.appendChild(li);
                });
                lucide.createIcons();
            }

            function renderHistory() {
                historyLogContainer.innerHTML = '';
                const sortedDays = Object.keys(data.dailyLogs).sort().reverse();
                let historyFound = false;
                sortedDays.forEach(dayKey => {
                    if(dayKey === todayKey) return; 
                    const log = data.dailyLogs[dayKey];
                    if (!log.summary || log.summary.revenue === 0) return; 
                    historyFound = true;
                    const summary = log.summary;
                    const dateFormatted = new Date(dayKey + 'T12:00:00').toLocaleDateString('pt-BR');
                    const isProfit = summary.profitLoss >= 0;
                    const profitClass = isProfit ? 'text-green-600' : 'text-red-600';
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-slate-50 rounded-md border text-sm';
                    div.innerHTML = `
                        <p class="font-bold text-slate-800">${dateFormatted}</p>
                        <div class="flex justify-between mt-1">
                            <span class="text-slate-600">Resultado:</span>
                            <span class="font-bold ${profitClass}">${formatCurrency(summary.profitLoss)}</span>
                        </div>
                         <div class="flex justify-between mt-1">
                            <span class="text-slate-600">Faturamento:</span>
                            <span class="font-medium">${formatCurrency(summary.revenue)}</span>
                        </div>
                    `;
                    historyLogContainer.appendChild(div);
                });
                if(!historyFound){
                     historyLogContainer.innerHTML = `<p class="text-sm text-slate-500 italic">Nenhum histórico salvo ainda.</p>`;
                }
            }
            
            // --- Funções de Cálculo ---
            function calculateAndDisplaySummary() {
                const config = data.config;
                const todayLog = data.dailyLogs[todayKey];
                const monthlyExpenses = parseValue(config.monthlyExpenses);
                const workingDays = parseInt(config.workingDays, 10) || 1;
                const dailyFixedCost = monthlyExpenses / workingDays;
                const dailyRevenue = todayLog.sales.reduce((sum, sale) => {
                    const product = data.masterProducts.find(p => p.name === sale.name);
                    return sum + (product ? product.price * sale.quantity : 0);
                }, 0);
                const dailyCogs = todayLog.sales.reduce((sum, sale) => {
                    const product = data.masterProducts.find(p => p.name === sale.name);
                    return sum + (product ? product.cost * sale.quantity : 0);
                }, 0);
                const taxPercentage = parseValue(config.taxPercentage) / 100;
                const cardFeePercentage = parseValue(config.cardFeePercentage) / 100;
                const variableExpenses = dailyRevenue * (taxPercentage + cardFeePercentage);
                const staffTotalCost = (parseValue(todayLog.staff.count) * parseValue(todayLog.staff.cost));
                const extraExpensesTotal = todayLog.extraExpenses.reduce((sum, exp) => sum + exp.value, 0);
                const profitLoss = dailyRevenue - dailyCogs - dailyFixedCost - variableExpenses - staffTotalCost - extraExpensesTotal;

                todayLog.summary = {
                    fixedCost: dailyFixedCost,
                    revenue: dailyRevenue,
                    cogs: dailyCogs,
                    variableExpenses: variableExpenses,
                    staffCost: staffTotalCost,
                    extraExpenses: extraExpensesTotal,
                    profitLoss: profitLoss
                };
                
                // Atualiza a UI
                dailyFixedCostEl.textContent = formatCurrency(dailyFixedCost);
                dailyRevenueEl.textContent = formatCurrency(dailyRevenue);
                dailyCogsEl.textContent = formatCurrency(dailyCogs);
                dailyVariableExpensesEl.textContent = formatCurrency(variableExpenses);
                dailyStaffTotalCostEl.textContent = formatCurrency(staffTotalCost);
                dailyExtraExpensesTotalEl.textContent = formatCurrency(extraExpensesTotal);
                profitLossResultEl.textContent = formatCurrency(profitLoss);

                if (profitLoss >= 0) {
                    profitLossCard.className = 'p-4 rounded-lg text-center transition-colors duration-300 bg-green-100 text-green-800';
                } else {
                    profitLossCard.className = 'p-4 rounded-lg text-center transition-colors duration-300 bg-red-100 text-red-800';
                }
                 // Não chamar saveData() aqui para evitar loops. O save é feito após ações do usuário.
            }

            // --- Event Listeners ---
            saveConfigBtn.addEventListener('click', () => {
                data.config.monthlyExpenses = monthlyExpensesInput.value;
                data.config.workingDays = workingDaysInput.value;
                data.config.taxPercentage = taxPercentageInput.value;
                data.config.cardFeePercentage = cardFeePercentageInput.value;
                saveData();
                calculateAndDisplaySummary();
                
                const btnText = saveConfigBtn.querySelector('.btn-text');
                saveConfigBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                saveConfigBtn.classList.add('bg-green-500');
                btnText.textContent = 'Salvo!';
                setTimeout(() => {
                    saveConfigBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    saveConfigBtn.classList.remove('bg-green-500');
                    btnText.textContent = 'Salvar Configurações';
                }, 2000);
            });

            importMenuBtn.addEventListener('click', () => menuCsvInput.click());
            menuCsvInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => parseMenuCSV(e.target.result);
                reader.readAsText(file);
                event.target.value = '';
            });

            function parseMenuCSV(csvText) {
                const rows = csvText.split('\n').filter(row => row.trim() !== '');
                const newProducts = [];
                rows.forEach(rowText => {
                    const cols = rowText.split(/[,;]/).map(s => s.trim());
                    if (cols.length < 3) return;
                    const name = cols[0];
                    const cost = parseValue(cols[1]);
                    const price = parseValue(cols[2]);
                    if(name && !isNaN(cost) && !isNaN(price)) newProducts.push({ name, cost, price });
                });

                if (newProducts.length > 0) {
                    data.masterProducts = newProducts;
                    data.masterProducts.sort((a, b) => a.name.localeCompare(b.name));
                    saveData();
                    updateUIFromData();
                    alert(`${newProducts.length} produtos foram importados com sucesso!`);
                } else {
                    alert("Nenhum produto válido foi encontrado no arquivo CSV. Verifique o formato.");
                }
            }

            manualAddProductBtn.addEventListener('click', () => {
                const name = manualProductName.value.trim();
                const cost = parseValue(manualProductCost.value);
                const price = parseValue(manualProductPrice.value);
                if (!name || cost <= 0 || price <= 0) {
                    alert("Por favor, preencha todos os campos do produto com valores válidos.");
                    return;
                }
                if (data.masterProducts.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                    alert("Já existe um produto com este nome.");
                    return;
                }
                data.masterProducts.push({ name, cost, price });
                data.masterProducts.sort((a, b) => a.name.localeCompare(b.name));
                saveData();
                renderMasterProductList();
                populateProductSelect();
                manualProductName.value = manualProductCost.value = manualProductPrice.value = '';
            });

            masterProductListContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-master-product-btn');
                if (removeBtn) {
                    const indexToRemove = parseInt(removeBtn.dataset.index, 10);
                    const productName = data.masterProducts[indexToRemove].name;
                    if(confirm(`Tem certeza que deseja remover "${productName}" do seu cardápio?`)){
                        data.masterProducts.splice(indexToRemove, 1);
                        saveData();
                        renderMasterProductList();
                        populateProductSelect();
                        calculateAndDisplaySummary();
                    }
                }
            });

            addSaleBtn.addEventListener('click', () => {
                const productIndex = productSelect.value;
                const quantity = parseInt(quantityInput.value, 10);
                if (productIndex === "" || isNaN(quantity) || quantity <= 0) {
                    alert("Selecione um produto e insira uma quantidade válida.");
                    return;
                }
                const selectedProduct = data.masterProducts[productIndex];
                data.dailyLogs[todayKey].sales.push({ name: selectedProduct.name, quantity });
                saveData();
                renderDailySalesTable();
                calculateAndDisplaySummary();
                quantityInput.value = 1;
                productSelect.value = "";
            });

            salesTableBody.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-sale-btn');
                if (removeBtn) {
                    const indexToRemove = parseInt(removeBtn.dataset.index, 10);
                    data.dailyLogs[todayKey].sales.splice(indexToRemove, 1);
                    saveData();
                    renderDailySalesTable();
                    calculateAndDisplaySummary();
                }
            });

            [staffCountInput, staffCostInput].forEach(input => {
                input.addEventListener('change', () => {
                    data.dailyLogs[todayKey].staff.count = staffCountInput.value;
                    data.dailyLogs[todayKey].staff.cost = staffCostInput.value;
                    saveData();
                    calculateAndDisplaySummary();
                });
            });

            addExtraExpenseBtn.addEventListener('click', () => {
                const desc = extraExpenseDescInput.value.trim();
                const value = parseValue(extraExpenseValueInput.value);
                if(!desc || value <= 0) {
                    alert("Preencha a descrição e um valor válido para a despesa extra.");
                    return;
                }
                data.dailyLogs[todayKey].extraExpenses.push({ desc, value });
                saveData();
                renderExtraExpensesList();
                calculateAndDisplaySummary();
                extraExpenseDescInput.value = extraExpenseValueInput.value = '';
            });

            extraExpensesListUl.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-extra-expense-btn');
                if (removeBtn) {
                    const indexToRemove = parseInt(removeBtn.dataset.index, 10);
                    data.dailyLogs[todayKey].extraExpenses.splice(indexToRemove, 1);
                    saveData();
                    renderExtraExpensesList();
                    calculateAndDisplaySummary();
                }
            });

            exportDailyReportBtn.addEventListener('click', () => {
                const summary = data.dailyLogs[todayKey].summary;
                if(!summary || summary.revenue === 0) {
                    alert("Não há dados de faturamento para exportar hoje.");
                    return;
                }
                
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += `Relatorio do Dia;${currentDate}\n\n`;

                csvContent += "Resumo Financeiro\n";
                csvContent += `Faturamento Bruto;${(summary.revenue || 0).toFixed(2)}\n`;
                csvContent += `Custo dos Produtos (CMV);-${(summary.cogs || 0).toFixed(2)}\n`;
                csvContent += `Custo Fixo do Dia;-${(summary.fixedCost || 0).toFixed(2)}\n`;
                csvContent += `Despesas Variáveis (Taxas);-${(summary.variableExpenses || 0).toFixed(2)}\n`;
                csvContent += `Custo com Diaristas;-${(summary.staffCost || 0).toFixed(2)}\n`;
                csvContent += `Despesas Extras;-${(summary.extraExpenses || 0).toFixed(2)}\n`;
                csvContent += `RESULTADO FINAL (LUCRO/PREJUIZO);${(summary.profitLoss || 0).toFixed(2)}\n\n`;

                csvContent += "Detalhe das Vendas\n";
                csvContent += "Produto;Qtd;Preco Venda Unit.;Custo Unit.;Faturamento Total;Custo Total\n";
                data.dailyLogs[todayKey].sales.forEach(sale => {
                    const product = data.masterProducts.find(p => p.name === sale.name);
                    const totalRevenue = product.price * sale.quantity;
                    const totalCost = product.cost * sale.quantity;
                    const row = [sale.name, sale.quantity, product.price.toFixed(2), product.cost.toFixed(2), totalRevenue.toFixed(2), totalCost.toFixed(2)].join(";");
                    csvContent += row + "\n";
                });
                csvContent += "\n";

                const extraExpenses = data.dailyLogs[todayKey].extraExpenses;
                if(extraExpenses.length > 0) {
                    csvContent += "Detalhe das Despesas Extras\n";
                    csvContent += "Descricao;Valor\n";
                    extraExpenses.forEach(exp => {
                         csvContent += `${exp.desc};${exp.value.toFixed(2)}\n`;
                    });
                    csvContent += "\n";
                }
                
                const staff = data.dailyLogs[todayKey].staff;
                if(parseValue(staff.count) > 0){
                     csvContent += "Detalhe Custo com Diaristas\n";
                     csvContent += `Numero de Diaristas;${staff.count}\n`;
                     csvContent += `Custo por Diarista;${parseValue(staff.cost).toFixed(2)}\n`;
                     csvContent += `Custo Total;${(parseValue(staff.count) * parseValue(staff.cost)).toFixed(2)}\n\n`;
                }

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `relatorio_diario_${todayKey}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });


            // --- INICIALIZAÇÃO ---
            loadData();
            lucide.createIcons();
        });
    </script>
</body>
</html>
