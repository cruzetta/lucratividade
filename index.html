<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Lucratividade para Restaurantes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.379.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .input-group input { padding-left: 2.75rem; }
        .input-group .icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #6b7280; }
        .result-card { transition: all 0.3s ease-in-out; }
        /* Animação para o spinner */
        .loader {
            border-top-color: #3498db;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8">
        <div class="max-w-4xl mx-auto">
            <!-- Cabeçalho -->
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Analisador de Lucratividade</h1>
                <p class="text-gray-600 mt-2">Uma visão completa da saúde financeira do seu negócio.</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-8">
                <!-- Seção 1: Produtos e Vendas -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 border-l-4 border-blue-500 pl-4 mb-4">1. Seus Produtos (Média Mensal)</h2>
                    <div id="product-list" class="space-y-4">
                        <div class="product-item grid grid-cols-1 md:grid-cols-12 gap-2 items-center border p-3 rounded-lg">
                            <input type="text" placeholder="Nome do Produto (Ex: Hambúrguer)" class="md:col-span-4 p-2 border rounded-md" data-field="name">
                            <input type="number" placeholder="Custo (R$)" class="md:col-span-2 p-2 border rounded-md" data-field="cost">
                            <input type="number" placeholder="Preço Venda (R$)" class="md:col-span-2 p-2 border rounded-md" data-field="price">
                            <input type="number" placeholder="Qtd. Vendida" class="md:col-span-2 p-2 border rounded-md" data-field="quantity">
                            <button class="remove-product-btn bg-red-100 text-red-600 p-2 rounded-md hover:bg-red-200 md:col-span-2 flex items-center justify-center">
                                <i data-lucide="trash-2" class="h-5 w-5"></i> <span class="ml-2 hidden md:inline">Remover</span>
                            </button>
                        </div>
                    </div>
                    <button id="add-product-btn" class="mt-4 bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600 flex items-center">
                        <i data-lucide="plus-circle" class="h-5 w-5 mr-2"></i> Adicionar Produto
                    </button>
                </div>

                <!-- Seção 2: Despesas Operacionais Mensais -->
                <div>
                     <h2 class="text-xl font-semibold text-gray-700 border-l-4 border-blue-500 pl-4 mb-4">2. Suas Despesas Mensais</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <!-- Despesas Fixas -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-medium text-gray-600">Despesas Fixas</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="relative input-group"><i data-lucide="home" class="icon"></i><input type="number" placeholder="Aluguel" id="rent" class="w-full p-2 border rounded-md"></div>
                                <div class="relative input-group"><i data-lucide="users" class="icon"></i><input type="number" placeholder="Salários e Encargos" id="salaries" class="w-full p-2 border rounded-md"></div>
                                <div class="relative input-group"><i data-lucide="briefcase" class="icon"></i><input type="number" placeholder="Pró-labore" id="proLabore" class="w-full p-2 border rounded-md"></div>
                                <div class="relative input-group"><i data-lucide="droplet" class="icon"></i><input type="number" placeholder="Água" id="water" class="w-full p-2 border rounded-md"></div>
                                <div class="relative input-group"><i data-lucide="zap" class="icon"></i><input type="number" placeholder="Energia" id="energy" class="w-full p-2 border rounded-md"></div>
                                <div class="relative input-group"><i data-lucide="flame" class="icon"></i><input type="number" placeholder="Gás" id="gas" class="w-full p-2 border rounded-md"></div>
                                <div class="relative input-group"><i data-lucide="megaphone" class="icon"></i><input type="number" placeholder="Publicidade" id="advertising" class="w-full p-2 border rounded-md"></div>
                                <div class="relative input-group"><i data-lucide="spray-can" class="icon"></i><input type="number" placeholder="Produtos de Limpeza" id="cleaning" class="w-full p-2 border rounded-md"></div>
                            </div>
                            <div class="pt-2">
                                <h4 class="text-md font-medium text-gray-600 mb-2">Outras Despesas Fixas</h4>
                                <div id="fixed-expenses-list" class="space-y-3"></div>
                                <button id="add-expense-btn" class="mt-3 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 flex items-center text-sm"><i data-lucide="plus" class="h-4 w-4 mr-2"></i> Adicionar Despesa</button>
                            </div>
                        </div>
                        <!-- Despesas Variáveis -->
                        <div class="space-y-3">
                            <h3 class="text-lg font-medium text-gray-600">Despesas Variáveis</h3>
                            <div class="relative input-group"><span class="icon">%</span><input type="number" placeholder="Impostos sobre Faturamento (%)" id="taxesPercentage" class="w-full p-2 border rounded-md"></div>
                            <div class="relative input-group"><span class="icon">%</span><input type="number" placeholder="Taxas de Cartão/Marketplace (%)" id="feesPercentage" class="w-full p-2 border rounded-md"></div>
                            <div class="relative input-group"><span class="icon">%</span><input type="number" placeholder="Perdas e Desperdícios (%)" id="wastePercentage" class="w-full p-2 border rounded-md"></div>
                        </div>
                    </div>
                </div>

                <!-- Botão de Calcular -->
                <div class="pt-4 text-center">
                    <button id="calculate-btn" class="w-full md:w-1/2 bg-green-600 text-white font-bold text-lg py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300">
                        Analisar Lucratividade
                    </button>
                </div>
            </div>

            <!-- Área de Resultado -->
            <div id="result-section" class="mt-8 hidden">
                 <h2 class="text-2xl md:text-3xl font-bold text-center mb-6 text-gray-800">Diagnóstico Financeiro</h2>
                <div id="profit-loss-message" class="p-4 rounded-lg text-center text-xl font-bold mb-6"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white p-5 rounded-xl shadow"><h3 class="font-semibold text-center text-gray-700 mb-4">Composição do Faturamento</h3><canvas id="compositionChart"></canvas></div>
                    <div class="bg-white p-5 rounded-xl shadow"><h3 class="font-semibold text-center text-gray-700 mb-4">Visão Geral Financeira</h3><canvas id="overviewChart"></canvas></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                    <div class="result-card bg-white p-5 rounded-xl shadow"><h4 class="font-semibold text-gray-500">Faturamento Bruto</h4><p id="total-revenue" class="text-2xl font-bold text-blue-600"></p></div>
                    <div class="result-card bg-white p-5 rounded-xl shadow"><h4 class="font-semibold text-gray-500">Custo dos Produtos (CMV)</h4><p id="total-cogs" class="text-2xl font-bold text-orange-600"></p></div>
                    <div class="result-card bg-white p-5 rounded-xl shadow"><h4 class="font-semibold text-gray-500">Lucro Bruto</h4><p id="gross-profit" class="text-2xl font-bold text-teal-600"></p><p id="gross-profit-margin" class="text-sm text-gray-500"></p></div>
                    <div class="result-card bg-white p-5 rounded-xl shadow"><h4 class="font-semibold text-gray-500">Despesas Operacionais</h4><p id="total-expenses" class="text-2xl font-bold text-red-600"></p><p id="expenses-breakdown" class="text-sm text-gray-500"></p></div>
                    <div class="result-card bg-white p-5 rounded-xl shadow"><h4 class="font-semibold text-gray-500">Ponto de Equilíbrio</h4><p id="break-even" class="text-2xl font-bold text-indigo-600"></p><p class="text-sm text-gray-500">Faturamento mínimo para cobrir os custos</p></div>
                    <div class="result-card bg-white p-5 rounded-xl shadow border-2" id="net-profit-card"><h4 class="font-semibold text-gray-500">Resultado Final (Lucro/Prejuízo)</h4><p id="net-profit" class="text-3xl font-extrabold"></p><p id="net-profit-margin" class="text-sm font-medium"></p></div>
                </div>

                 <!-- NOVA SEÇÃO: Análise com IA -->
                <div class="mt-10">
                    <div class="text-center">
                        <button id="gemini-analysis-btn" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition duration-300 flex items-center justify-center mx-auto">
                           <span id="gemini-btn-text">✨ Gerar Análise e Sugestões com IA</span>
                           <div id="gemini-loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></div>
                        </button>
                    </div>
                    <div id="gemini-result-container" class="mt-6 bg-white p-6 rounded-xl shadow hidden prose prose-indigo max-w-none">
                        <!-- O resultado da IA será inserido aqui -->
                    </div>
                </div>
            </div>
            <div id="error-message" class="mt-6 p-4 text-center text-red-700 bg-red-100 font-medium rounded-lg hidden"></div>
        </div>
    </div>

    <script>
        let compositionChart = null;
        let overviewChart = null;
        let lastCalculationData = {}; // Guarda os dados do último cálculo para a IA

        document.addEventListener("DOMContentLoaded", function() {
            lucide.createIcons();
            // Restante do seu código DOMContentLoaded...
            const productList = document.getElementById('product-list');
            const addProductBtn = document.getElementById('add-product-btn');
            const fixedExpensesList = document.getElementById('fixed-expenses-list');
            const addExpenseBtn = document.getElementById('add-expense-btn');
            const productTemplate = productList.children[0].cloneNode(true);
            const createExpenseTemplate = () => {
                const div = document.createElement('div');
                div.className = "expense-item grid grid-cols-12 gap-2 items-center";
                div.innerHTML = `<input type="text" placeholder="Nome da despesa" class="col-span-6 p-2 border rounded-md" data-field="name"><input type="number" placeholder="Valor (R$)" class="col-span-4 p-2 border rounded-md" data-field="value"><button class="remove-expense-btn bg-red-100 text-red-600 p-2 rounded-md hover:bg-red-200 col-span-2 flex items-center justify-center"><i data-lucide="trash-2" class="h-5 w-5"></i></button>`;
                return div;
            };
            const expenseTemplate = createExpenseTemplate();
            addProductBtn.addEventListener('click', () => {
                const newProductRow = productTemplate.cloneNode(true);
                newProductRow.querySelectorAll('input').forEach(input => input.value = '');
                productList.appendChild(newProductRow);
                lucide.createIcons();
            });
            productList.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-product-btn');
                if (removeBtn) {
                    if (productList.children.length > 1) {
                        removeBtn.closest('.product-item').remove();
                    } else {
                        showError("É necessário pelo menos um produto na lista.");
                    }
                }
            });
            addExpenseBtn.addEventListener('click', () => {
                const newExpenseRow = expenseTemplate.cloneNode(true);
                fixedExpensesList.appendChild(newExpenseRow);
                lucide.createIcons();
            });
            fixedExpensesList.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-expense-btn');
                if (removeBtn) {
                    removeBtn.closest('.expense-item').remove();
                }
            });
        });
        const calculateBtn = document.getElementById('calculate-btn');
        const resultSection = document.getElementById('result-section');
        const errorMessageDiv = document.getElementById('error-message');
        const geminiBtn = document.getElementById('gemini-analysis-btn');
        const geminiResultContainer = document.getElementById('gemini-result-container');

        const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const getNumericValue = (id) => parseFloat(document.getElementById(id).value) || 0;
        
        function showError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
            resultSection.classList.add('hidden');
        }

        calculateBtn.addEventListener('click', () => {
            errorMessageDiv.classList.add('hidden');
            let isValid = true;
            let productData = [];
            let totalRevenue = 0, totalCogs = 0;
            document.querySelectorAll('.product-item').forEach(item => {
                const name = item.querySelector('[data-field="name"]').value || 'Produto sem nome';
                const cost = parseFloat(item.querySelector('[data-field="cost"]').value);
                const price = parseFloat(item.querySelector('[data-field="price"]').value);
                const quantity = parseFloat(item.querySelector('[data-field="quantity"]').value);
                if (isNaN(cost) || isNaN(price) || isNaN(quantity) || cost < 0 || price < 0 || quantity < 0) isValid = false;
                totalRevenue += price * quantity;
                totalCogs += cost * quantity;
                productData.push({ name, cost, price, quantity, profit_per_unit: price - cost });
            });
            
            let fixedExpenses = getNumericValue('rent') + getNumericValue('salaries') + getNumericValue('proLabore') + getNumericValue('water') + getNumericValue('energy') + getNumericValue('gas') + getNumericValue('advertising') + getNumericValue('cleaning');
            
            document.querySelectorAll('#fixed-expenses-list .expense-item').forEach(item => {
                const value = parseFloat(item.querySelector('[data-field="value"]').value);
                if (!isNaN(value) && value > 0) fixedExpenses += value;
            });

            const taxesPercentage = getNumericValue('taxesPercentage');
            const feesPercentage = getNumericValue('feesPercentage');
            const wastePercentage = getNumericValue('wastePercentage');

            if (!isValid || fixedExpenses < 0 || taxesPercentage < 0 || feesPercentage < 0 || wastePercentage < 0) {
                showError("Por favor, preencha todos os campos com valores numéricos válidos e positivos.");
                return;
            }
            const variableExpensesPercentage = taxesPercentage + feesPercentage + wastePercentage;
            const variableExpensesValue = totalRevenue > 0 ? totalRevenue * (variableExpensesPercentage / 100) : 0;
            const totalExpenses = fixedExpenses + variableExpensesValue;
            const grossProfit = totalRevenue - totalCogs;
            const netProfit = grossProfit - totalExpenses;
            const breakEvenPoint = (totalRevenue - totalCogs - variableExpensesValue) > 0 ? fixedExpenses / ((totalRevenue - totalCogs - variableExpensesValue) / totalRevenue) : 0;
            
            if (totalRevenue <= 0) {
                showError("O faturamento total deve ser maior que zero para gerar um diagnóstico. Verifique os preços e quantidades vendidas.");
                return;
            }
            
            // Armazena os dados para a IA
            lastCalculationData = {
                productData,
                totalRevenue,
                totalCogs,
                fixedExpenses,
                variableExpensesValue,
                totalExpenses,
                netProfit,
                breakEvenPoint
            };

            // Exibição dos resultados...
            document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('total-cogs').textContent = formatCurrency(totalCogs);
            document.getElementById('gross-profit').textContent = formatCurrency(grossProfit);
            document.getElementById('gross-profit-margin').textContent = `Margem de ${(grossProfit / totalRevenue * 100).toFixed(2)}%`;
            document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('expenses-breakdown').textContent = `Fixas: ${formatCurrency(fixedExpenses)} | Variáveis: ${formatCurrency(variableExpensesValue)}`;
            document.getElementById('break-even').textContent = formatCurrency(breakEvenPoint);
            const netProfitP = document.getElementById('net-profit');
            const profitLossMessage = document.getElementById('profit-loss-message');
            netProfitP.textContent = formatCurrency(netProfit);
            //...
             if (netProfit >= 0) {
                profitLossMessage.className = 'p-4 rounded-lg text-center text-xl font-bold mb-6 bg-green-100 text-green-800';
                profitLossMessage.textContent = "Parabéns! Sua operação está dando lucro.";
            } else {
                profitLossMessage.className = 'p-4 rounded-lg text-center text-xl font-bold mb-6 bg-red-100 text-red-800';
                profitLossMessage.textContent = "Atenção! Sua operação está gerando prejuízo.";
            }

            updateCharts({ totalCogs, totalExpenses, netProfit, totalRevenue, breakEvenPoint });
            resultSection.classList.remove('hidden');
            geminiResultContainer.classList.add('hidden'); // Esconde análise antiga
            window.scrollTo({ top: resultSection.offsetTop - 20, behavior: 'smooth' });
        });

        function updateCharts(data) {
            if (compositionChart) { compositionChart.destroy(); }
            if (overviewChart) { overviewChart.destroy(); }
            const compositionCtx = document.getElementById('compositionChart').getContext('2d');
            compositionChart = new Chart(compositionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Custo dos Produtos (CMV)', 'Despesas Operacionais', 'Lucro Líquido'],
                    datasets: [{
                        data: [data.totalCogs, data.totalExpenses, data.netProfit > 0 ? data.netProfit : 0],
                        backgroundColor: ['#f97316', '#ef4444', '#16a34a'],
                        borderColor: '#ffffff', borderWidth: 2
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.raw)}` } } } }
            });
            const overviewCtx = document.getElementById('overviewChart').getContext('2d');
            overviewChart = new Chart(overviewCtx, {
                type: 'bar',
                data: {
                    labels: ['Valores Totais'],
                    datasets: [
                        { label: 'Faturamento Bruto', data: [data.totalRevenue], backgroundColor: '#3b82f6' },
                        { label: 'Custos + Despesas', data: [data.totalCogs + data.totalExpenses], backgroundColor: '#ef4444' },
                        { label: 'Ponto de Equilíbrio', data: [data.breakEvenPoint], backgroundColor: '#8b5cf6' }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { callback: (v) => formatCurrency(v) } } }, plugins: { tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${formatCurrency(c.raw)}` } } } }
            });
        }
        
        // --- LÓGICA DA API GEMINI ---
        geminiBtn.addEventListener('click', async () => {
            if (Object.keys(lastCalculationData).length === 0) {
                showError("Por favor, calcule a lucratividade primeiro antes de gerar a análise.");
                return;
            }

            const geminiLoader = document.getElementById('gemini-loader');
            const geminiBtnText = document.getElementById('gemini-btn-text');

            geminiLoader.classList.remove('hidden');
            geminiBtnText.classList.add('hidden');
            geminiBtn.disabled = true;
            geminiResultContainer.classList.add('hidden');

            const prompt = `
                Você é um consultor financeiro especialista em restaurantes e pequenos negócios de alimentação no Brasil.
                Analise os seguintes dados financeiros mensais de um restaurante e forneça um diagnóstico e recomendações.

                DADOS FINANCEIROS:
                - Faturamento Bruto: ${formatCurrency(lastCalculationData.totalRevenue)}
                - Custo dos Produtos Vendidos (CMV): ${formatCurrency(lastCalculationData.totalCogs)}
                - Despesas Fixas: ${formatCurrency(lastCalculationData.fixedExpenses)}
                - Despesas Variáveis: ${formatCurrency(lastCalculationData.variableExpensesValue)}
                - Lucro Líquido Final: ${formatCurrency(lastCalculationData.netProfit)}
                - Ponto de Equilíbrio: ${formatCurrency(lastCalculationData.breakEvenPoint)}
                - Detalhes dos Produtos: ${JSON.stringify(lastCalculationData.productData, null, 2)}

                TAREFA:
                Crie um relatório conciso com as seguintes seções:
                1.  **Diagnóstico Rápido:** Um parágrafo resumindo a saúde financeira geral do negócio, mencionando o resultado (lucro ou prejuízo) e a margem líquida.
                2.  **Pontos Fortes:** Uma lista com 2 ou 3 pontos positivos, como os produtos mais vendidos ou mais lucrativos.
                3.  **Pontos de Atenção:** Uma lista com 2 ou 3 pontos que precisam de melhoria, como custos elevados ou produtos com baixa performance.
                4.  **Recomendações Acionáveis:** Uma lista de 3 a 5 sugestões práticas e diretas para aumentar a lucratividade. As sugestões podem envolver preços, marketing, controle de custos ou otimização do cardápio.

                Use um tom profissional, mas encorajador. Formate a resposta usando Markdown simples.
            `;

            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content.parts[0].text) {
                    const analysisText = result.candidates[0].content.parts[0].text;
                    geminiResultContainer.innerHTML = simpleMarkdownToHtml(analysisText);
                    geminiResultContainer.classList.remove('hidden');
                } else {
                    throw new Error("Resposta da API inválida.");
                }

            } catch (error) {
                geminiResultContainer.innerHTML = `<p class="text-red-600">Ocorreu um erro ao gerar a análise. Tente novamente. Detalhe: ${error.message}</p>`;
                geminiResultContainer.classList.remove('hidden');
            } finally {
                geminiLoader.classList.add('hidden');
                geminiBtnText.classList.remove('hidden');
                geminiBtn.disabled = false;
            }
        });

        function simpleMarkdownToHtml(text) {
            let html = text
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*)\*/gim, '<em>$1</em>')
                .replace(/^\s*\n\*/gm, '<ul>\n*')
                .replace(/^(\*.+)\s*\n([^*])/gm, '$1\n</ul>\n$2')
                .replace(/^\* (.*$)/gim, '<li>$1</li>');
            
            return html.split('\n').map(p => p.startsWith('<') ? p : `<p>${p}</p>`).join('');
        }

    </script>
</body>
</html>
