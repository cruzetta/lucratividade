<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Ferramentas de Negócio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.379.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Garante que o cabeçalho fixo não cubra o título da secção ao navegar */
        section {
            scroll-margin-top: 80px;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        #simulation-panel {
            transition: opacity 0.5s ease-in-out, max-height 0.8s ease-in-out;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .highlight-card {
            background-color: #fffbeb;
            border: 1px solid #facc15;
        }
        /* Estilos do Analisador */
        #analisador .input-group input { padding-left: 2.75rem; }
        #analisador .input-group .icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #6b7280; }
        #analisador .result-card { transition: all 0.3s ease-in-out; }
        #analisador .loader {
            border-top-color: #3498db;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- CABEÇALHO DE NAVEGAÇÃO FIXO -->
    <header class="bg-white/80 backdrop-blur-lg shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 md:px-8 flex justify-between items-center h-16">
            <div class="flex space-x-4 md:space-x-8">
                <a href="#analisador" class="text-slate-600 hover:text-indigo-600 font-semibold transition self-center">Analisador de Lucratividade</a>
                <a href="#calculadora" class="text-slate-600 hover:text-indigo-600 font-semibold transition self-center">Calculadora de Preços</a>
            </div>
            <a href="https://wa.me/5567999093031" target="_blank" rel="noopener noreferrer" class="hidden sm:inline-flex items-center bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-all transform hover:scale-105">
                <i data-lucide="message-circle" class="h-5 w-5 mr-2"></i>
                Fale Comigo
            </a>
        </nav>
    </header>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- ================================================================== -->
        <!-- SECÇÃO 1: ANALISADOR DE LUCRATIVIDADE                             -->
        <!-- ================================================================== -->
        <section id="analisador" class="py-8">
             <div class="max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Analisador de Lucratividade</h1>
                    <p class="text-gray-600 mt-2">Uma visão completa da saúde financeira do seu negócio.</p>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-8">
                    <!-- Entradas do Analisador -->
                    <div>
                        <h2 class="text-xl font-semibold text-gray-700 border-l-4 border-blue-500 pl-4 mb-4">1. Seus Produtos (Média Mensal)</h2>
                        <div id="analisador-product-list" class="space-y-4">
                            <div class="product-item grid grid-cols-1 md:grid-cols-12 gap-2 items-center border p-3 rounded-lg">
                                <input type="text" placeholder="Nome do Produto (Ex: Hambúrguer)" class="md:col-span-4 p-2 border rounded-md" data-field="name">
                                <input type="number" placeholder="Custo (R$)" class="md:col-span-2 p-2 border rounded-md" data-field="cost">
                                <input type="number" placeholder="Preço Venda (R$)" class="md:col-span-2 p-2 border rounded-md" data-field="price">
                                <input type="number" placeholder="Qtd. Vendida" class="md:col-span-2 p-2 border rounded-md" data-field="quantity">
                                <button class="remove-product-btn bg-red-100 text-red-600 p-2 rounded-md hover:bg-red-200 md:col-span-2 flex items-center justify-center">
                                    <i data-lucide="trash-2" class="h-5 w-5"></i> <span class="ml-2 hidden md:inline">Remover</span>
                                </button>
                            </div>
                        </div>
                        <button id="analisador-add-product-btn" class="mt-4 bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600 flex items-center">
                            <i data-lucide="plus-circle" class="h-5 w-5 mr-2"></i> Adicionar Produto
                        </button>
                    </div>
                    <div>
                         <h2 class="text-xl font-semibold text-gray-700 border-l-4 border-blue-500 pl-4 mb-4">2. Suas Despesas Mensais</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div class="space-y-4">
                                <h3 class="text-lg font-medium text-gray-600">Despesas Fixas</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="relative input-group"><i data-lucide="home" class="icon"></i><input type="number" placeholder="Aluguel" id="rent" class="w-full p-2 border rounded-md" data-label="Aluguel"></div>
                                    <div class="relative input-group"><i data-lucide="users" class="icon"></i><input type="number" placeholder="Salários e Encargos" id="salaries" class="w-full p-2 border rounded-md" data-label="Salarios e Encargos"></div>
                                    <div class="relative input-group"><i data-lucide="briefcase" class="icon"></i><input type="number" placeholder="Pró-labore" id="proLabore" class="w-full p-2 border rounded-md" data-label="Pro-labore"></div>
                                    <div class="relative input-group"><i data-lucide="droplet" class="icon"></i><input type="number" placeholder="Água" id="water" class="w-full p-2 border rounded-md" data-label="Agua"></div>
                                    <div class="relative input-group"><i data-lucide="zap" class="icon"></i><input type="number" placeholder="Energia" id="energy" class="w-full p-2 border rounded-md" data-label="Energia"></div>
                                    <div class="relative input-group"><i data-lucide="flame" class="icon"></i><input type="number" placeholder="Gás" id="gas" class="w-full p-2 border rounded-md" data-label="Gas"></div>
                                    <div class="relative input-group"><i data-lucide="megaphone" class="icon"></i><input type="number" placeholder="Publicidade" id="advertising" class="w-full p-2 border rounded-md" data-label="Publicidade"></div>
                                    <div class="relative input-group"><i data-lucide="spray-can" class="icon"></i><input type="number" placeholder="Produtos de Limpeza" id="cleaning" class="w-full p-2 border rounded-md" data-label="Produtos de Limpeza"></div>
                                </div>
                                <div class="pt-2">
                                    <h4 class="text-md font-medium text-gray-600 mb-2">Outras Despesas Fixas</h4>
                                    <div id="fixed-expenses-list" class="space-y-3"></div>
                                    <button id="add-expense-btn" class="mt-3 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 flex items-center text-sm"><i data-lucide="plus" class="h-4 w-4 mr-2"></i> Adicionar Despesa</button>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <h3 class="text-lg font-medium text-gray-600">Despesas Variáveis</h3>
                                <div class="relative input-group"><span class="icon">%</span><input type="number" placeholder="Impostos sobre Faturamento (%)" id="taxesPercentage" class="w-full p-2 border rounded-md"></div>
                                <div class="relative input-group"><span class="icon">%</span><input type="number" placeholder="Taxas de Cartão/Marketplace (%)" id="feesPercentage" class="w-full p-2 border rounded-md"></div>
                                <div class="relative input-group"><span class="icon">%</span><input type="number" placeholder="Perdas e Desperdícios (%)" id="wastePercentage" class="w-full p-2 border rounded-md"></div>
                            </div>
                        </div>
                    </div>
                    <div class="pt-4 text-center">
                        <button id="calculate-btn" class="w-full md:w-1/2 bg-green-600 text-white font-bold text-lg py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300">
                            Analisar Lucratividade
                        </button>
                    </div>
                </div>

                <!-- Área de Resultado do Analisador -->
                <div id="result-section" class="mt-8 hidden">
                     <h2 class="text-2xl md:text-3xl font-bold text-center mb-6 text-gray-800">Diagnóstico Financeiro</h2>
                    <div id="profit-loss-message" class="p-4 rounded-lg text-center text-xl font-bold mb-6"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="bg-white p-5 rounded-xl shadow"><h3 class="font-semibold text-center text-gray-700 mb-4">Composição do Faturamento</h3><canvas id="compositionChart"></canvas></div>
                        <div class="bg-white p-5 rounded-xl shadow"><h3 class="font-semibold text-center text-gray-700 mb-4">Visão Geral Financeira</h3><canvas id="overviewChart"></canvas></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                        <div class="result-card bg-white p-5 rounded-xl shadow"><h4 class="font-semibold text-gray-500">Faturamento Bruto</h4><p id="total-revenue-analyzer" class="text-2xl font-bold text-blue-600"></p></div>
                        <div class="result-card bg-white p-5 rounded-xl shadow"><h4 class="font-semibold text-gray-500">Custo dos Produtos (CMV)</h4><p id="total-cogs" class="text-2xl font-bold text-orange-600"></p></div>
                        <div class="result-card bg-white p-5 rounded-xl shadow"><h4 class="font-semibold text-gray-500">Lucro Bruto</h4><p id="gross-profit" class="text-2xl font-bold text-teal-600"></p><p id="gross-profit-margin" class="text-sm text-gray-500"></p></div>
                        <div class="result-card bg-white p-5 rounded-xl shadow"><h4 class="font-semibold text-gray-500">Despesas Operacionais</h4><p id="total-expenses" class="text-2xl font-bold text-red-600"></p><p id="expenses-breakdown" class="text-sm text-gray-500"></p></div>
                        <div class="result-card bg-white p-5 rounded-xl shadow"><h4 class="font-semibold text-gray-500">Ponto de Equilíbrio</h4><p id="break-even" class="text-2xl font-bold text-indigo-600"></p><p class="text-sm text-gray-500">Faturamento mínimo para cobrir os custos</p></div>
                        <div class="result-card bg-white p-5 rounded-xl shadow border-2" id="net-profit-card"><h4 class="font-semibold text-gray-500">Resultado Final (Lucro/Prejuízo)</h4><p id="net-profit" class="text-3xl font-extrabold"></p><p id="net-profit-margin" class="text-sm font-medium"></p></div>
                    </div>
                    <div class="mt-10 text-center">
                        <button id="gemini-analysis-btn" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition duration-300 flex items-center justify-center mx-auto">
                           <span id="gemini-btn-text">✨ Gerar Análise com IA</span>
                           <div id="gemini-loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></div>
                        </button>
                        <div id="gemini-result-container" class="mt-6 bg-white p-6 rounded-xl shadow hidden prose prose-indigo max-w-none text-left"></div>
                    </div>
                    <div class="mt-8 text-center">
                        <button id="export-analyzer-csv-btn" class="bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-800 flex items-center justify-center mx-auto">
                            <i data-lucide="sheet" class="h-5 w-5 mr-2"></i> Exportar Dados (CSV)
                        </button>
                    </div>
                </div>
                <div id="error-message" class="mt-6 p-4 text-center text-red-700 bg-red-100 font-medium rounded-lg hidden"></div>
            </div>
        </section>

        <hr class="my-12 border-slate-300">

        <!-- ================================================================== -->
        <!-- SECÇÃO 2: CALCULADORA DE PREÇO POR META DE VENDAS                  -->
        <!-- ================================================================== -->
        <section id="calculadora" class="py-8">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Calculadora de Preço por Meta de Vendas</h1>
                <p class="mt-2 text-md md:text-lg text-slate-600">Planeie a sua estratégia de preços para atingir os seus objetivos de lucro.</p>
            </header>
            <main id="calculator-input-section" class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="card col-span-1 md:col-span-2">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-900">1. Custos da Operação</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="fixed-costs" class="block text-sm font-medium text-slate-700">Total Despesas Fixas Mensais (R$)</label>
                                <input type="number" id="fixed-costs" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Ex: 20000">
                            </div>
                            <div>
                                <label for="variable-costs" class="block text-sm font-medium text-slate-700">Despesas Variáveis (%)</label>
                                <input type="number" id="variable-costs" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Ex: 15">
                            </div>
                        </div>
                    </div>
                    <div class="card col-span-1">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-900">2. Meta de Negócio</h2>
                        <div>
                            <label for="profit-goal" class="block text-sm font-medium text-slate-700">Lucro Livre Mensal Desejado (R$)</label>
                            <input type="number" id="profit-goal" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Ex: 10000">
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-900">3. Produtos/Serviços</h2>
                    <div id="calculator-product-list" class="space-y-4">
                        <div id="product-template" class="grid grid-cols-12 gap-x-4 gap-y-2 items-end p-2 rounded-lg border border-transparent" style="display: none;">
                            <div class="col-span-12 sm:col-span-4 md:col-span-3">
                                <label class="block text-sm font-medium text-slate-700">Nome do Produto</label>
                                <input type="text" name="product-name" class="input-field mt-1 w-full" placeholder="Ex: Sagrado Burger">
                            </div>
                            <div class="col-span-6 sm:col-span-4 md:col-span-2">
                                <label class="block text-sm font-medium text-slate-700">Custo Direto (R$)</label>
                                <input type="number" name="direct-cost" class="input-field mt-1 w-full" placeholder="Ex: 15">
                            </div>
                            <div class="col-span-6 sm:col-span-4 md:col-span-2">
                                <label class="block text-sm font-medium text-slate-700">Meta Vendas (Unid.)</label>
                                <input type="number" name="sales-goal" class="input-field mt-1 w-full" placeholder="Ex: 500">
                            </div>
                            <div class="col-span-12 sm:col-span-8 md:col-span-3">
                                <label class="block text-sm font-medium text-slate-700">Preço Venda Atual (R$) <span class="text-slate-500">(Opcional)</span></label>
                                <input type="number" name="current-price" class="input-field mt-1 w-full" placeholder="Ex: 65">
                            </div>
                            <div class="col-span-12 sm:col-span-4 md:col-span-2 flex items-end justify-end">
                                <button type="button" class="remove-product-btn bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600 transition w-full sm:w-auto">Remover</button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button type="button" id="calculator-add-product-btn" class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-md hover:bg-blue-600 transition">
                            + Adicionar Produto
                        </button>
                    </div>
                     <small class="block mt-4 text-slate-500">Nota: O Custo Direto deve incluir todos os custos variáveis por unidade (ex: ingredientes, embalagem, etc.)</small>
                </div>
                <div class="text-center pt-6">
                    <button id="create-panel-btn" class="bg-indigo-600 text-white font-bold text-lg px-8 py-4 rounded-lg hover:bg-indigo-700 transition shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                        Criar meu Painel de Simulação
                    </button>
                </div>
            </main>

            <div id="simulation-panel" class="space-y-8 opacity-0 max-h-0 overflow-hidden">
                <div class="card">
                     <h2 class="text-2xl font-bold mb-4 text-slate-900">Resultado Geral da Simulação</h2>
                     <div id="general-results" class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                        <div class="bg-green-100 p-4 rounded-lg"><p class="text-sm text-green-800 font-medium">Faturamento Total</p><p id="total-revenue-calculator" class="text-2xl font-bold text-green-900">R$ 0,00</p></div>
                        <div class="bg-red-100 p-4 rounded-lg"><p class="text-sm text-red-800 font-medium">Custos Totais</p><p id="total-costs" class="text-2xl font-bold text-red-900">R$ 0,00</p></div>
                        <div class="bg-indigo-100 p-4 rounded-lg"><p class="text-sm text-indigo-800 font-medium">Lucro Livre Final</p><p id="final-profit" class="text-2xl font-bold text-indigo-900">R$ 0,00</p></div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-2xl font-bold mb-4 text-slate-900">Painel Interativo de Produtos</h2>
                    <div id="interactive-cards-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card"><h2 class="text-2xl font-bold mb-4 text-slate-900">Análise de Custos por Unidade</h2><div id="unit-cost-analysis" class="space-y-4"></div></div>
                    <div class="card"><h2 class="text-2xl font-bold mb-4 text-slate-900">Planeamento de Metas</h2>
                        <div class="space-y-6">
                            <div><h3 class="text-lg font-semibold text-indigo-700">Cenário 1: Descobrir o Preço Ideal</h3><p class="text-sm text-slate-600 mb-2">Para atingir sua meta de lucro com as quantidades atuais, os preços deveriam ser:</p><div id="price-scenario-results" class="space-y-2"></div></div>
                            <div><h3 class="text-lg font-semibold text-indigo-700">Cenário 2: Descobrir a Venda Necessária</h3><p class="text-sm text-slate-600 mb-2">Para atingir sua meta de lucro com os preços atuais, as vendas deveriam ser:</p><div id="quantity-scenario-results" class="space-y-2"></div></div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 text-center">
                    <button id="export-calculator-csv-btn" class="bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-800 flex items-center justify-center mx-auto hidden">
                        <i data-lucide="sheet" class="h-5 w-5 mr-2"></i> Exportar Dados (CSV)
                    </button>
                </div>
            </div>
        </section>
    </div>
    
    <footer class="mt-12 mb-8">
        <div class="max-w-4xl mx-auto px-4">
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <h3 class="text-xl font-bold text-gray-800">Quer trocar uma ideia sobre seu negócio?</h3>
                <p class="text-gray-600 mt-2 mb-4">Vamos conversar sobre como otimizar seus resultados.</p>
                <a href="https://wa.me/5567999093031" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-transform transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 mr-2"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"></path></svg>
                    Fala comigo!
                </a>
            </div>
        </div>
    </footer>

    <!-- SCRIPTS DEVEM FICAR NO FINAL DO BODY -->
    <!-- Script para o ANALISADOR DE LUCRATIVIDADE -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const section = document.querySelector('#analisador');
            if (!section) return;

            let compositionChart = null, overviewChart = null, lastCalculationData = {};
            lucide.createIcons();
            
            const productList = section.querySelector('#analisador-product-list');
            const addProductBtn = section.querySelector('#analisador-add-product-btn');
            const fixedExpensesList = section.querySelector('#fixed-expenses-list');
            const addExpenseBtn = section.querySelector('#add-expense-btn');
            const productTemplate = productList.children[0].cloneNode(true);
            
            const createExpenseTemplate = () => {
                const div = document.createElement('div');
                div.className = "expense-item grid grid-cols-12 gap-2 items-center";
                div.innerHTML = `<input type="text" placeholder="Nome da despesa" class="col-span-6 p-2 border rounded-md" data-field="name"><input type="number" placeholder="Valor (R$)" class="col-span-4 p-2 border rounded-md" data-field="value"><button class="remove-expense-btn bg-red-100 text-red-600 p-2 rounded-md hover:bg-red-200 col-span-2 flex items-center justify-center"><i data-lucide="trash-2" class="h-5 w-5"></i></button>`;
                return div;
            };
            const expenseTemplate = createExpenseTemplate();
            
            addProductBtn.addEventListener('click', () => {
                const newProductRow = productTemplate.cloneNode(true);
                newProductRow.querySelectorAll('input').forEach(input => input.value = '');
                productList.appendChild(newProductRow);
                lucide.createIcons();
            });

            productList.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-product-btn');
                if (removeBtn && productList.children.length > 1) removeBtn.closest('.product-item').remove();
            });

            addExpenseBtn.addEventListener('click', () => {
                const newExpenseRow = expenseTemplate.cloneNode(true);
                fixedExpensesList.appendChild(newExpenseRow);
                lucide.createIcons();
            });

            fixedExpensesList.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-expense-btn');
                if (removeBtn) removeBtn.closest('.expense-item').remove();
            });
            
            const calculateBtn = section.querySelector('#calculate-btn');
            const resultSection = section.querySelector('#result-section');
            const errorMessageDiv = section.querySelector('#error-message');
            const geminiBtn = section.querySelector('#gemini-analysis-btn');
            const geminiResultContainer = section.querySelector('#gemini-result-container');
            const exportCsvBtn = section.querySelector('#export-analyzer-csv-btn');

            const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const formatNumber = (value) => (value || 0).toLocaleString('pt-BR');
            const getNumericValue = (id) => parseFloat(section.querySelector(`#${id}`).value) || 0;
            
            function showError(message) {
                errorMessageDiv.textContent = message;
                errorMessageDiv.classList.remove('hidden');
                resultSection.classList.add('hidden');
            }

            calculateBtn.addEventListener('click', () => {
                errorMessageDiv.classList.add('hidden');
                let isValid = true;
                let productData = [];
                let totalRevenue = 0, totalCogs = 0;
                
                productList.querySelectorAll('.product-item').forEach(item => {
                    const name = item.querySelector('[data-field="name"]').value || 'Produto sem nome';
                    const cost = parseFloat(item.querySelector('[data-field="cost"]').value);
                    const price = parseFloat(item.querySelector('[data-field="price"]').value);
                    const quantity = parseFloat(item.querySelector('[data-field="quantity"]').value);
                    if (isNaN(cost) || isNaN(price) || isNaN(quantity) || cost < 0 || price < 0 || quantity < 0) isValid = false;
                    totalRevenue += price * quantity;
                    totalCogs += cost * quantity;
                    productData.push({ name, cost, price, quantity, profit_per_unit: price - cost });
                });
                
                let fixedExpensesInputs = section.querySelectorAll('[data-label]');
                let otherFixedExpenses = [];
                let fixedExpenses = 0;
                fixedExpensesInputs.forEach(input => fixedExpenses += parseFloat(input.value) || 0);

                fixedExpensesList.querySelectorAll('.expense-item').forEach(item => {
                    const name = item.querySelector('[data-field="name"]').value || 'Outra Despesa';
                    const value = parseFloat(item.querySelector('[data-field="value"]').value) || 0;
                    if (value > 0) {
                        fixedExpenses += value;
                        otherFixedExpenses.push({ name, value });
                    }
                });

                const taxesPercentage = getNumericValue('taxesPercentage');
                const feesPercentage = getNumericValue('feesPercentage');
                const wastePercentage = getNumericValue('wastePercentage');

                if (!isValid) return showError("Preencha todos os campos dos produtos com valores válidos.");
                if (totalRevenue <= 0) return showError("O faturamento deve ser maior que zero. Verifique preços e quantidades.");
                
                const variableExpensesPercentage = taxesPercentage + feesPercentage + wastePercentage;
                const variableExpensesValue = totalRevenue * (variableExpensesPercentage / 100);
                const totalExpenses = fixedExpenses + variableExpensesValue;
                const grossProfit = totalRevenue - totalCogs;
                const netProfit = grossProfit - totalExpenses;
                const breakEvenPoint = (totalRevenue - totalCogs - variableExpensesValue) > 0 ? fixedExpenses / ((totalRevenue - totalCogs - variableExpensesValue) / totalRevenue) : 0;
                
                lastCalculationData = { productData, totalRevenue, totalCogs, fixedExpenses, fixedExpensesInputs, otherFixedExpenses, variableExpensesValue, totalExpenses, netProfit, breakEvenPoint, taxesPercentage, feesPercentage, wastePercentage };

                section.querySelector('#total-revenue-analyzer').textContent = formatCurrency(totalRevenue);
                section.querySelector('#total-cogs').textContent = formatCurrency(totalCogs);
                section.querySelector('#gross-profit').textContent = formatCurrency(grossProfit);
                section.querySelector('#gross-profit-margin').textContent = `Margem de ${(grossProfit / totalRevenue * 100).toFixed(2)}%`;
                section.querySelector('#total-expenses').textContent = formatCurrency(totalExpenses);
                section.querySelector('#expenses-breakdown').textContent = `Fixas: ${formatCurrency(fixedExpenses)} | Variáveis: ${formatCurrency(variableExpensesValue)}`;
                section.querySelector('#break-even').textContent = formatCurrency(breakEvenPoint);
                const profitLossMessage = section.querySelector('#profit-loss-message');
                section.querySelector('#net-profit').textContent = formatCurrency(netProfit);
                
                if (netProfit >= 0) {
                    profitLossMessage.className = 'p-4 rounded-lg text-center text-xl font-bold mb-6 bg-green-100 text-green-800';
                    profitLossMessage.textContent = "Parabéns! Sua operação está dando lucro.";
                } else {
                    profitLossMessage.className = 'p-4 rounded-lg text-center text-xl font-bold mb-6 bg-red-100 text-red-800';
                    profitLossMessage.textContent = "Atenção! Sua operação está gerando prejuízo.";
                }

                updateCharts({ totalCogs, totalExpenses, netProfit, totalRevenue, breakEvenPoint });
                resultSection.classList.remove('hidden');
                geminiResultContainer.classList.add('hidden'); 
                window.scrollTo({ top: resultSection.offsetTop - 80, behavior: 'smooth' });
            });

            function updateCharts(data) { /* ... (código do gráfico inalterado) ... */ }
            geminiBtn.addEventListener('click', async () => { /* ... (lógica da IA inalterada) ... */ });
            function simpleMarkdownToHtml(text) { /* ... (lógica do markdown inalterada) ... */ }
            
            exportCsvBtn.addEventListener('click', () => {
                if (Object.keys(lastCalculationData).length === 0) return alert("Calcule a lucratividade primeiro.");
                
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Relatorio de Analise de Lucratividade\n\n";
                
                csvContent += "Resumo Financeiro\n";
                csvContent += `Faturamento Bruto;${formatNumber(lastCalculationData.totalRevenue)}\n`;
                csvContent += `Custo dos Produtos (CMV);${formatNumber(lastCalculationData.totalCogs)}\n`;
                csvContent += `Lucro Bruto;${formatNumber(lastCalculationData.totalRevenue - lastCalculationData.totalCogs)}\n`;
                csvContent += `Despesas Fixas Totais;${formatNumber(lastCalculationData.fixedExpenses)}\n`;
                csvContent += `Despesas Variaveis Totais;${formatNumber(lastCalculationData.variableExpensesValue)}\n`;
                csvContent += `Total de Despesas;${formatNumber(lastCalculationData.totalExpenses)}\n`;
                csvContent += `Resultado Final (Lucro/Prejuizo);${formatNumber(lastCalculationData.netProfit)}\n`;
                csvContent += `Ponto de Equilibrio;${formatNumber(lastCalculationData.breakEvenPoint)}\n\n`;

                csvContent += "Detalhes dos Produtos\n";
                csvContent += "Nome;Custo Unitario;Preco de Venda;Qtd Vendida;Receita Total;Lucro Total do Produto\n";
                lastCalculationData.productData.forEach(p => {
                    const row = [p.name, formatNumber(p.cost), formatNumber(p.price), p.quantity, formatNumber(p.price * p.quantity), formatNumber((p.price - p.cost) * p.quantity)].join(";");
                    csvContent += row + "\n";
                });
                csvContent += "\n";
                
                // --- INÍCIO DA CORREÇÃO ---
                csvContent += "Detalhes das Despesas\n";
                csvContent += "Tipo;Item;Valor\n";
                // Despesas Fixas Padrão
                lastCalculationData.fixedExpensesInputs.forEach(input => {
                    const label = input.getAttribute('data-label') || 'Despesa';
                    const value = parseFloat(input.value) || 0;
                    if (value > 0) {
                        csvContent += `Fixa;${label};${formatNumber(value)}\n`;
                    }
                });
                // Outras Despesas Fixas
                lastCalculationData.otherFixedExpenses.forEach(expense => {
                    csvContent += `Fixa;${expense.name};${formatNumber(expense.value)}\n`;
                });
                // Despesas Variáveis
                csvContent += `Variavel (%);Impostos (%);${lastCalculationData.taxesPercentage}\n`;
                csvContent += `Variavel (%);Taxas (%);${lastCalculationData.feesPercentage}\n`;
                csvContent += `Variavel (%);Perdas (%);${lastCalculationData.wastePercentage}\n`;
                // --- FIM DA CORREÇÃO ---
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "analise_lucratividade.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });
    </script>
    
    <!-- Script para a CALCULADORA DE PREÇOS -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const section = document.querySelector('#calculadora');
            if (!section) return;

            const addProductBtn = section.querySelector('#calculator-add-product-btn');
            const productList = section.querySelector('#calculator-product-list');
            const productTemplate = section.querySelector('#product-template');
            const createPanelBtn = section.querySelector('#create-panel-btn');
            const simulationPanel = section.querySelector('#simulation-panel');
            const interactiveCardsContainer = section.querySelector('#interactive-cards-container');
            const unitCostAnalysis = section.querySelector('#unit-cost-analysis');
            const priceScenarioResults = section.querySelector('#price-scenario-results');
            const quantityScenarioResults = section.querySelector('#quantity-scenario-results');
            const exportCsvBtn = section.querySelector('#export-calculator-csv-btn');

            let lastSimulationData = {};

            const formatCurrency = (value) => !isNaN(value) && isFinite(value) ? value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00';
            const formatNumber = (value) => (value || 0).toLocaleString('pt-BR');
            const parseInput = (value, isFloat = true) => (isFloat ? parseFloat(value) : parseInt(value, 10)) || 0;
            
            const addNewProduct = () => {
                const newProductRow = productTemplate.cloneNode(true);
                newProductRow.style.display = 'grid';
                newProductRow.removeAttribute('id');
                newProductRow.querySelectorAll('input').forEach(input => input.classList.add('p-2', 'rounded-md', 'border-slate-300', 'shadow-sm', 'w-full'));
                productList.appendChild(newProductRow);
            };

            productList.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-product-btn');
                if (removeBtn && productList.querySelectorAll('.grid:not(#product-template)').length > 1) removeBtn.closest('.grid').remove();
            });

            const updateSimulation = () => {
                const fixedCosts = parseInput(section.querySelector('#fixed-costs').value);
                const variableCostsPercent = parseInput(section.querySelector('#variable-costs').value) / 100;
                const profitGoal = parseInput(section.querySelector('#profit-goal').value);
                
                let productsData = [];
                interactiveCardsContainer.querySelectorAll('.product-card').forEach((card) => {
                    const id = card.dataset.productId;
                    const name = card.querySelector('.product-name').textContent;
                    const directCost = parseInput(card.dataset.directCost);
                    const salesGoal = parseInput(card.querySelector(`[name="sales-goal-${id}"]`).value, false);
                    const sellingPrice = parseInput(card.querySelector(`[name="selling-price-${id}"]`).value);
                    productsData.push({ id, name, directCost, salesGoal, sellingPrice });
                });

                const totalUnitsSold = productsData.reduce((sum, p) => sum + p.salesGoal, 0);
                const totalRevenue = productsData.reduce((sum, p) => sum + (p.salesGoal * p.sellingPrice), 0);
                const totalDirectCosts = productsData.reduce((sum, p) => sum + (p.salesGoal * p.directCost), 0);
                const totalVariableCostsBasedOnRevenue = totalRevenue * variableCostsPercent;
                const totalCosts = fixedCosts + totalDirectCosts + totalVariableCostsBasedOnRevenue;
                const finalProfit = totalRevenue - totalCosts;

                section.querySelector('#total-revenue-calculator').textContent = formatCurrency(totalRevenue);
                section.querySelector('#total-costs').textContent = formatCurrency(totalCosts);
                section.querySelector('#final-profit').textContent = formatCurrency(finalProfit);

                productsData.forEach(p => {
                    section.querySelector(`#product-revenue-${p.id}`).textContent = formatCurrency(p.salesGoal * p.sellingPrice);
                });

                let analysisData = [];
                unitCostAnalysis.innerHTML = '';
                if (totalUnitsSold > 0 && (1 - variableCostsPercent) > 0) {
                    const fixedCostPerUnit = fixedCosts / totalUnitsSold;
                    productsData.forEach(p => {
                        const breakEvenPrice = (p.directCost + fixedCostPerUnit) / (1 - variableCostsPercent);
                        analysisData.push({name: p.name, breakEvenPrice});
                        unitCostAnalysis.innerHTML += `
                            <div class="border p-4 rounded-lg space-y-3">
                                <h4 class="font-bold text-lg text-slate-800">${p.name}</h4>
                                <div class="highlight-card p-4 rounded-lg text-center">
                                    <h5 class="font-semibold text-yellow-800">Ponto de Equilíbrio por Unidade</h5>
                                    <p class="font-bold text-yellow-900 text-2xl mt-1">${formatCurrency(breakEvenPrice)}</p>
                                    <p class="text-xs text-yellow-700 mt-1">(Preço mínimo para cobrir todos os custos)</p>
                                </div>
                            </div>
                        `;
                    });
                } else {
                     unitCostAnalysis.innerHTML = '<p class="text-slate-500">Dados insuficientes.</p>';
                }

                let priceScenarioData = [], quantityScenarioData = [];
                priceScenarioResults.innerHTML = '';
                if ((1 - variableCostsPercent) > 0) {
                    const requiredTotalRevenue = (fixedCosts + totalDirectCosts + profitGoal) / (1 - variableCostsPercent);
                    if (isFinite(requiredTotalRevenue) && requiredTotalRevenue >= 0 && totalRevenue > 0) {
                         productsData.forEach(p => {
                            const revenueShare = totalRevenue > 0 ? (p.salesGoal * p.sellingPrice) / totalRevenue : 1 / productsData.length;
                            const requiredProductRevenue = requiredTotalRevenue * revenueShare;
                            const requiredPrice = p.salesGoal > 0 ? requiredProductRevenue / p.salesGoal : 0;
                            priceScenarioData.push({name: p.name, requiredPrice});
                            priceScenarioResults.innerHTML += `<div class="flex justify-between items-center text-sm"><span>${p.name}:</span> <span class="font-bold">${formatCurrency(requiredPrice)}</span></div>`;
                        });
                    }
                }

                quantityScenarioResults.innerHTML = '';
                const marginPerUnitMix = (totalRevenue * (1 - variableCostsPercent) - totalDirectCosts) / totalUnitsSold;
                if (isFinite(marginPerUnitMix) && marginPerUnitMix > 0) {
                    const requiredTotalUnits = (fixedCosts + profitGoal) / marginPerUnitMix;
                    const multiplier = totalUnitsSold > 0 ? requiredTotalUnits / totalUnitsSold : 0;
                    productsData.forEach(p => {
                        const requiredQuantity = p.salesGoal * multiplier;
                        quantityScenarioData.push({name: p.name, requiredQuantity: Math.ceil(requiredQuantity)});
                        quantityScenarioResults.innerHTML += `<div class="flex justify-between items-center text-sm"><span>${p.name}:</span> <span class="font-bold">${Math.ceil(requiredQuantity).toLocaleString('pt-BR')} unid.</span></div>`;
                    });
                }
                lastSimulationData = { fixedCosts, variableCostsPercent, profitGoal, productsData, totalRevenue, totalCosts, finalProfit, analysisData, priceScenarioData, quantityScenarioData };
            };

            const initializePanel = () => {
                interactiveCardsContainer.innerHTML = '';
                const productRows = productList.querySelectorAll('.grid:not(#product-template)');
                if (productRows.length === 0) return alert('Adicione pelo menos um produto.');
                
                productRows.forEach((row, index) => {
                    const id = `p${index}`, name = row.querySelector('[name="product-name"]').value || `Produto ${index + 1}`,
                          directCost = row.querySelector('[name="direct-cost"]').value, salesGoal = row.querySelector('[name="sales-goal"]').value,
                          currentPrice = row.querySelector('[name="current-price"]').value;
                    const card = document.createElement('div');
                    card.className = "product-card border rounded-lg p-4 space-y-3 bg-slate-50";
                    card.dataset.productId = id; card.dataset.directCost = directCost;
                    card.innerHTML = `
                        <h3 class="product-name font-bold text-lg text-slate-800 truncate">${name}</h3>
                        <div><label class="text-sm font-medium">Meta Vendas (Unid.)</label><input type="number" name="sales-goal-${id}" value="${salesGoal}" class="w-full p-2 rounded border"></div>
                        <div><label class="text-sm font-medium">Preço de Venda (R$)</label><input type="number" name="selling-price-${id}" value="${currentPrice}" class="w-full p-2 rounded border"></div>
                        <div class="bg-white p-2 rounded-md text-center mt-2"><p class="text-sm">Receita do Produto</p><p class="font-semibold text-lg text-green-700" id="product-revenue-${id}">-</p></div>`;
                    interactiveCardsContainer.appendChild(card);
                });
                simulationPanel.style.maxHeight = simulationPanel.scrollHeight + 1000 + 'px';
                simulationPanel.style.opacity = '1';
                exportCsvBtn.classList.remove('hidden');
                lucide.createIcons();
                simulationPanel.scrollIntoView({ behavior: 'smooth' });
                updateSimulation();
            };
            
            addProductBtn.addEventListener('click', addNewProduct);
            createPanelBtn.addEventListener('click', initializePanel);
            simulationPanel.addEventListener('input', (e) => { if(e.target.tagName === 'INPUT') updateSimulation(); });
            
            exportCsvBtn.addEventListener('click', () => {
                if (Object.keys(lastSimulationData).length === 0) return alert("Crie um painel de simulação primeiro.");

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Relatorio - Calculadora de Preco por Meta de Vendas\n\n";

                csvContent += "Entradas Principais\n";
                csvContent += `Despesas Fixas Mensais;${formatNumber(lastSimulationData.fixedCosts)}\n`;
                csvContent += `Despesas Variaveis (%);${(lastSimulationData.variableCostsPercent * 100).toFixed(2)}%\n`;
                csvContent += `Meta de Lucro Desejado;${formatNumber(lastSimulationData.profitGoal)}\n\n`;

                csvContent += "Resultado Geral da Simulacao\n";
                csvContent += `Faturamento Total;${formatNumber(lastSimulationData.totalRevenue)}\n`;
                csvContent += `Custos Totais;${formatNumber(lastSimulationData.totalCosts)}\n`;
                csvContent += `Lucro Livre Final;${formatNumber(lastSimulationData.finalProfit)}\n\n`;

                csvContent += "Produtos Simulados e Ponto de Equilibrio\n";
                csvContent += "Produto;Custo Direto;Meta Vendas;Preco Simulado;Receita;Ponto de Equilibrio Unitario\n";
                lastSimulationData.productsData.forEach(p => {
                    const analysis = lastSimulationData.analysisData.find(a => a.name === p.name);
                    const row = [p.name, formatNumber(p.directCost), p.salesGoal, formatNumber(p.sellingPrice), formatNumber(p.salesGoal * p.sellingPrice), analysis ? formatNumber(analysis.breakEvenPrice) : 'N/A'].join(";");
                    csvContent += row + "\n";
                });
                csvContent += "\n";

                csvContent += "Cenario 1 - Preco Ideal para Atingir a Meta\n";
                csvContent += "Produto;Preco Ideal Necessario\n";
                lastSimulationData.priceScenarioData.forEach(p => csvContent += `${p.name};${formatNumber(p.requiredPrice)}\n`);
                csvContent += "\n";

                csvContent += "Cenario 2 - Venda Necessaria para Atingir a Meta\n";
                csvContent += "Produto;Venda Necessaria (Unidades)\n";
                lastSimulationData.quantityScenarioData.forEach(p => csvContent += `${p.name};${p.requiredQuantity}\n`);
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "calculadora_precos_simulacao.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            addNewProduct();
        });
    </script>
</body>
</html>
